# Language Server Protocol (LSP)

プログラミング言語において、`autocomplete`, `goto definition`, `documentation on hover` などの機能を実装することは、大変な労力を必要とする。 従来は、開発ツールごとに同じ機能を実装するための API が異なるため、この作業を繰り返さなければならなかった。
言語サーバーの背後にある考え方は、`プロセス間通信を可能にするプロトコル`で`開発ツール`と通信できるサーバー内に言語固有のスマートさを提供すること。
そのため、単一の Language Server を複数の開発ツールで再利用でき、ツールは最小限の労力で言語をサポートできる。
`LSP` は、言語プロバイダーとツール ベンダーの両方にとって有益となる。

- [Official](https://microsoft.github.io/language-server-protocol/)
- [github](https://github.com/microsoft/language-server-protocol)

## Vscode で Golang を使う場合の挙動

どのようにして、Vscode 上で、特定の言語の`autocomplete`, `goto definition`, `documentation on hover` が実現されるのか？

VSCode を使用している間、`言語サーバー`は`ユーザーのマシン上で別のプロセスとしてローカルで実行`され、VSCode と通信して、オートコンプリートや定義の参照などの言語固有の機能を提供している。

### 1. **言語サーバー**

言語サーバーは、プログラミング言語を理解する`スタンドアロンプログラム`。Go の場合、一般的な言語サーバーは `gopls`

### 2. **VSCode**

VSCode で Go ファイルを開くと、エディターは通常、ローカルループバックネットワーク接続を介して、ネットワークプロトコル上の LSP を使用して `gopls` 言語サーバーと通信する。

#### 余談: ループバック(loopback)

`ループバック(loopback)`とは、送信したものが自分に帰ってくるようにすること、あるいはそのような状態のこと。
自分が送った送信信号をそのまま受信し返し、信号が正しく送信できているかどうかを確認するのに用いられる。
TCP/IP では、「127.0.0.1」がループバックアドレスとして使われる

### 3. **言語サーバーの実行場所**

- 言語サーバーは`ローカルマシン上で個別のプロセスとして実行`される。通常、Go プロジェクトを開くと、VSCode によって起動および管理される。
- VSCode は(オートコンプリートや定義の検索などの)リクエストを`gopls`サーバーに送信し、`gopls`サーバーはコードを解析してリクエストを処理し、その結果を VSCode に返す。

### 4. **通信**

- この通信は `JSON-RPC` 接続を介して行われ、エディターと言語サーバーが LSP 仕様に従ってフォーマットされた JSON メッセージを交換することを意味する。
- 言語サーバーはローカルファイルシステム上のファイルにアクセスし、処理を行い、必要な情報を VSCode に返す。

## プログラム言語以外で使われる LSP

`Language Server Protocol(LSP)`は、Go、Python、TypeScript などの従来のプログラミング言語に限定されるものではない。当初はこれらの言語をサポートするために開発されたが、その柔軟性により、幅広い`テキストベースの言語`や`ファイル形式`にも対応できる。

### 1. **マークアップ言語**

- **HTML**:LSP は、HTML ファイルに対してオートコンプリート、構文強調表示、文法チェックを提供できる
- **Markdown**:LSP サーバーは、Markdown ファイルに対して構文検証、ライブプレビュー、リンク検証などの機能を提供できる

### 2. **設定言語**

- **YAML/JSON**:LSP は、YAML または JSON で記述された設定ファイルに対して、スキーマ検証、オートコンプリート、構文チェックを提供できる
- **Dockerfile**:LSP サーバーは、Dockerfile に対して、構文チェックやオートコンプリートなどの機能を提供できる

### 3. **クエリ言語**

- **SQL**:LSP は、クエリ検証、SQL キーワードのオートコンプリート、データベーススキーマのインスペクションを提供することで、SQL をサポートできる
- **GraphQL**:LSP は、フィールドのオートコンプリート、構文チェック、スキーマに対する検証を提供できる

### 4. **ドキュメントフォーマット**

- **LaTeX**: LSP は、LaTeX ファイルの構文チェック、引用のオートコンプリート、ドキュメントアウトラインのサポートなどの機能を提供するために使用できる
- **ReStructuredText**: Markdown と同様に、LSP は ReStructuredText ドキュメントの編集体験を向上させることができる

### 5. **カスタム DSL(ドメイン固有言語)**

- 多くのツールやフレームワークがカスタム DSL を使用しており、LSP はこれらの DSL に言語固有の機能(オートコンプリート、構文強調表示、エラーチェックなど)を提供するために適応させることができる

### 6. **スクリプトおよびオートメーション言語**

- **Bash/Shell スクリプト**:LSP は、構文強調表示、エラー検出、コマンド補完をサポートする
- **PowerShell**:PowerShell スクリプトにも同様のサポートが利用可能

### 7. **文章および自然言語**

- **自然言語の記述**:LSP は、プレーンテキストまたはリッチテキスト文書におけるスペルチェック、文法チェック、スタイルの提案などの作業にますます利用されるようになっている

### 8. **数学および科学言語**

- **MATLAB**: LSP は、関数のドキュメント参照やコード補完などの機能により、MATLAB のような科学技術計算言語をサポートすることができる
- **Wolfram Language**: 同様のサポートは、科学技術計算で使用される専門言語にも拡張することができる

## References

- [Language Server Protocol の仕様 及び実装方法 (2023)](https://zenn.dev/mtshiba/books/language_server_protocol)
