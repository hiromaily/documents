# データ指向アプリケーションデザイン

[WIP]

[Oreilly: データ指向アプリケーションデザイン - 信頼性、拡張性、保守性の高い分散システム設計の原理 (2017)](https://www.oreilly.co.jp/books/9784873118703/)

原書のタイトル：`Designing Data-Intensive Application`  
これを直訳すると、`データ集約型アプリケーションの設計`となる

## データ指向アプリケーションデザインとは

- `データ指向`はこの本で定義された新しい訳語
- データ指向とは、`データの量`、`複雑さ`、`変化の速度`を中心に考えるデザインであり、「`データの量`、`複雑さ`、`変化の速度`」に対応できるシステム設計

## データの種類

### テキストフォーマット

- CSV, JSON, XML

### バイナリフォーマット

- MessagePack
- ProtocolBuffers
- Thrift
- Apache Avro

## データを作る場合、何を考慮するか

### データが少ない場合

- `データの表現`、`生成しやすさ`が重視される

### データが多い場合

- データ基盤では、`省メモリ`、`圧縮しやすさ`、`ストレージへの格納しやすさ`が重視される
- テーブルフォーマット
  - スキーマとレコード表現を分離
    - カラム名、型の情報を繰り返して出力しない分、コンパクト
- 行指向(row-oriented)フォーマット
  - RDBMS でよく使われる
  - 1 レコード ずつ表現
  - レコード単位で更新しやすい
- 列指向(column-oriented)フォーマット
  - 列(カラム)
  - 同じ型のデータを集めると圧縮しやすい
  - 分析クエリ向き
    - Cache に乗りやすく高速
    - SIMD 演算も活用しやすい
  - 一方、単一レコードの更新は大変

## 列指向データフォーマット (Columnar Format)

- [Apache Parquet](https://parquet.apache.org/)
  - ネストして繰り返しのあるデータでも、同じパスごとに分解、圧縮する
  - `Spark`, `DuckDB`といったデータ処理エンジン などでサポート
- クラウド上のストレージ (SWS S3)
  - スループットは高いが、ランダムアクセスの latency ＧＡ大きい (10ms~数百 ms)
  - 1 ファイル内でページ分割、フッターに各ページへのインデックスを格納

## データが変化する速度は？

- 変化しない場合: 不変データ (immutable data)
  - 例: 蓄積されるログデータ。`列指向フォーマット`が使いやすい
- 読み込み特化型 (read-intensive)
  - データへの高速なアクセス、分析の速さが問われる
- 読み込み特化型の高速化手法: `データを分散する`
  - パーティショニング (シャーディングなど)
    - データを時間単位(e.g. 1h, 1day)、あるいはキーの範囲で分割する
    - 必要なデータのみにアクセスしたり、別領域のデータへの並列アクセスを可能に
  - レプリケーション
    - 同じデータを複数箇所(マシン, ディスク)に配備する
    - 並列アクセスしやすくし、耐障害性をもたせる
  - 実体化ビュー (Materialized View)
    - 一度計算したクエリ結果を保存し、再利用できるように

## データが頻繁に更新される場合

- 書き込み特化型 (write-intensive)
  - RDBMS が強い分野
    - レコード単位での更新
    - トランザクション処理
  - 更新対象をどう素早く見つける？
    - インデックス: ディスク上のデータを高速に見つけるためのデータ構造
      - B-Tree, Hash index, SSTable (Stored String Table)

## ディスク上のインデックス構造: B-Tree
