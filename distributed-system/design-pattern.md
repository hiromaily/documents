# 分散システムデザインパターン

## 第 Ⅰ 部　シングルノードパターン

### シングルノードパターンを使う理由

- リソースの分離
- 関心の分離・影響範囲の局所化
- デプロイやロールバックを容易にする

### 2 章 サイドカー

- 1 台のマシン上で動く 2 つのコンテナから構成されるパターン。
- ホスト名、ネットワーク、ディスクなど多くを共有する。

- サイドカーの例：レガシーサービスの HTTPS 対応
  - nginx などの SSL のプロキシを挟んで、localhost 上でアプリケーションを動かしてアクセスする。
  - アプリケーションがレガシーで HTTPS の対応が難しいときなど。
- サイドカーによる動的な設定
  - クラウドネイティブな場合、設定は API で更新する方が便利。
  - 既存のアプリケーションを拡張するよりも、サイドカーに設定を更新させるようにさせた方が容易なことがある。
- モジュール化されたアプリケーションコンテナ
  - コンポーネントのモジュール化と再利用性の例
  - プロセス情報を取得するために API を提供する場合
    - 各アプリケーションで統一的に対応するのは言語が異なったりして困難。
    - サイドカーを利用して一貫したインターフェースで情報を提供できるようになる。

### 3 章 アンバサダ (代理人)

- アプリケーションが外部サービスに接続する際に、プロキシとなるコンテナを経由させるコンテナグループを作るパターン

#### 1. サービスのシャーディングへのアンバサダの利用

シャーディング: データベースの負荷分散方法の 1 種で、 水平分割

Redis 等でシャーディングさせてる際に、ノードを増やす度にアプリケーションをデプロイし直す必要がなくなり、ロジックを共通化できてアンバサダコンテナを独立してデプロイすることができる。

#### 2. サービスブローカとしての利用

開発環境や、本番環境などで外部サービスのホストやポートの設定が異なる可能性が高いが、そのロジックをアンバサダコンテナに委譲できる。

#### 3. 新システムの実験的運用やリクエスト分割への利用

バージョンアップなどで新システムを本番環境に導入する際にも、試験的に導入することができる。
例えばアンバサダの設定を変更して、既存のシステムを稼働させつつ、新システムにも同じリクエストを裏側で送って負荷を確認することができる。

### 4 章 アダプタ

コンテナグループ外に対して、外部インターフェイスを提供する際にアダプタコンテナを経由して提供するパターン。

- 監視
  - 監視ツール用のインターフェースに変換することで、アプリケーションの責務を分けることができる。
  - 監視コンテナを提供する開発者と、アプリケーションの開発者を切り分けることができる。
- ロギング
  - 監視と異なり、ログはレベルごとにファイルが異なったり、標準出力してるだけのことがあり、フォーマットがバラバラ。
  - アダプタパターンで、モジュール化して再利用して、フォーマットを統一することができる。

## 第 Ⅱ 部　マルチノードパターン

### 6 章 シャーディングされたサービス

#### 1. シャーディングされたキャッシュ

シャーディングされてる場合は、一つのノードが死んだ場合に特定のユーザへのレスポンスが遅くなるリスクがあるため、キャッシュのレプリカを用意したほうが高可用になる。

#### 2. シャーディング関数を試してみる

##### キーの選択

異なる国からリクエストがある場合、言語ごとにキャッシュを切り替える必要があるため、単に IP アドレスを元にハッシュを生成するのは良くない。

##### コンシステントハッシュ関数

ノードの数を増やすと再シャーディングする必要がある。このとき、シンプルなハッシュ関数だと再シャーディングのコストが高くなる可能性があるが、コンシステントハッシュ関数を使うと効率的に再シャーディングできる。

### 7 章 スキャッタ・ギャザー

バックエンド内で、複数のノードを使って処理を分散させて高速化させるパターン。ただし複数のノードを使うことによるデメリットもある。

- ノードごとのオーバヘッドがあるので、並列性を上げても必ずしも処理速度が上がるとは限らない
- 落ちこぼれ問題（一部のノードでレスポンスが遅くなって全体のレスポンスが遅くなる問題）のため、並列度を上げても処理速度が上がるとは限らない。
- 一つのノードで障害が起こると全体が止まるので、シャーディング毎にレプリカは必須。
  - （バージョンアップを行う際などでノードは必ず止めないといけないタイミングがある。）

### 9 章 オーナーシップの選出

マスタの選出の実装は困難なため、 etcd や Apache ZooKeeper、Consul などのコンセンサスアルゴリズムを利用する。

## 第 Ⅲ 部 バッチ処理パターン

Apache Kafka を使った Pub/Sub のパターンや、MapReduce フレームワークでの協調する手法
