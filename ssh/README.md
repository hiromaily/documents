# SSH

SSH（Secure Shell）は、ネットワークを介して他のコンピュータと安全に通信するためのプロトコル。SSHコマンドを使用することで、リモートサーバーにログインしたり、ファイルを転送したり、リモートコマンドを実行したりすることができる。SSHは、データ通信を暗号化するために、セキュリティ面でも優れている。

## 基本的なSSHコマンド

### 1. リモートサーバーへのログイン

リモートサーバーにログインする基本的なコマンドは次の通り

```sh
ssh [ユーザー名]@[ホスト名またはIPアドレス]
# e.g.
ssh user@192.168.1.1
```

### 2. 指定したポートでログイン

デフォルトではSSHはポート`22`を使用するが、異なるポートを指定する場合は `-p オプション` を使う

```sh
ssh -p [ポート番号] [ユーザー名]@[ホスト名またはIPアドレス]
# e.g.
ssh -p 2222 user@192.168.1.1
```

### 3. プライベートキーを指定してログイン

プライベートキーを指定してログインする方法は次の通り

```sh
ssh -i [プライベートキーのパス] [ユーザー名]@[ホスト名またはIPアドレス]
# e.g.
ssh -i ~/.ssh/id_rsa user@192.168.1.1
```

### 4. リモートコマンドの実行

リモートサーバー上でコマンドを実行したい場合

```sh
ssh [ユーザー名]@[ホスト名またはIPアドレス] [コマンド]
# e.g.
ssh user@192.168.1.1 'ls -l /var/www'
```

## SCPコマンド（ファイル転送）

SCP（Secure Copy）は、SSHプロトコルを使用してファイルをリモートサーバー間でコピーするためのコマンド

### 1. ローカルからリモートへファイルをコピー

```sh
scp [ローカルファイルのパス] [ユーザー名]@[ホスト名またはIPアドレス]:[リモートのパス]
# e.g
scp /path/to/localfile.txt user@192.168.1.1:/path/to/remotefile.txt
```

### 2. リモートからローカルへファイルをコピー

```sh
scp [ユーザー名]@[ホスト名またはIPアドレス]:[リモートファイルのパス] [ローカルパス]
# e.g.
scp user@192.168.1.1:/path/to/remotefile.txt /path/to/localfile.txt
```

## SSHの設定ファイル（~/.ssh/config）

頻繁にSSHを使用する場合、設定ファイルを使って接続を簡略化することができる。`~/.ssh/config`ファイルに設定を記述することで、以下のような簡単な接続が可能になる。

```sh
ssh myserver
```

`~/.ssh/config`の例：

```text
Host myserver
    HostName 192.168.1.1
    User user
    Port 22
    IdentityFile ~/.ssh/id_rsa
```

## SSHトンネル（SSHポートフォワーディング）

SSHトンネル（SSHポートフォワーディング）は、SSHプロトコルを利用して、ローカルホストとリモートホスト間でセキュアな通信経路を確立する技術。

### SSHトンネルの機能

1. **ローカルポートフォワーディング**:
   - ローカルホストからリモートホストへの接続を可能にする。例えば、ローカルの特定のポートをリモートホストの特定のポートに転送することで、直接アクセスできないサーバーにアクセスできる。

2. **リモートポートフォワーディング（リバースポートフォワーディング）**:
   - リモートホストからローカルホストへの接続を可能にします。双方向の通信が必要な場合や、外部からの直接アクセスを制限したい場合に使用される。

3. **ダイナミックポートフォワーディング**:
   - ローカルホストの特定のポートを使用し、リモートホストへの接続を可能にする。SOCKSプロキシとして使用され、特定のサービスへのアクセスが可能。

### SSHトンネルの設定方法

1. **コマンドラインでの設定**:
   - `ssh`コマンドにオプションを追加して設定することができる。
   - 例：`ssh -L <ローカルポート>:<リモートホスト>:<リモートポート> <ユーザー>@<リモートホスト>`（ローカルポートフォワーディング）
   - 例：`ssh -R <ローカルポート>:<ローカルホスト>:<ローカルポート> <ユーザー>@<リモートホスト>`（リモートポートフォワーディング）
   - 例：`ssh -D <ローカルポート> <ユーザー>@<リモートホスト>`（ダイナミックポートフォワーディング）

2. **`~/.ssh/config`ファイルでの設定**:
   - `Host`、`HostName`、`Port`、`User`、`IdentityFile`などの設定を行い、トンネル設定を追加します。
   - 例：`LocalForward <ローカルポート> <リモートホスト>:<リモートポート>`（ローカルポートフォワーディング）
   - 例：`RemoteForward <ローカルポート> <ローカルホスト>:<ローカルポート>`（リモートポートフォワーディング）
   - 例：`DynamicForward <ローカルポート>`（ダイナミックポートフォワーディング）

### SSHトンネルの設定方法例

**コマンドラインでの設定**:

- ローカルポートフォワーディング：`ssh -L 5432:database.example.com:5432 user@step-host`
- リモートポートフォワーディング：`ssh -R 80:localhost:8080 user@remote-host`
- ダイナミックポートフォワーディング：`ssh -D 1080 user@proxy-host`

**`~/.ssh/config`ファイルでの設定**:

```config
Host database
  HostName database.example.com
  Port 22
  User user
  IdentityFile ~/.ssh/my_key
  LocalForward 5432 database.example.com:5432

Host remote
  HostName remote-host.com
  Port 22
  User user
  IdentityFile ~/.ssh/my_key
  RemoteForward 80 localhost:8080

Host proxy
  HostName proxy-host.com
  Port 22
  User user
  IdentityFile ~/.ssh/my_key
  DynamicForward 1080
```
