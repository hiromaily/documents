# どのようなケースで AWS Lambda を使うべきか？

独立したバッチプログラムを Cron ジョブで実行すべきケースとの違いについて

- `短時間で頻繁に実行されるタスクはLambda`
- `長時間または複雑な依存関係があるタスクはCronジョブ`


- [Lambda 関数呼び出しタイムアウトエラーをトラブルシューティングするにはどうすればよいですか?](https://repost.aws/ja/knowledge-center/lambda-troubleshoot-invocation-timeouts)

## AWS Lambda を使うべきケース

1. **短時間のタスク**: Lambda は基本的に短時間の処理に向いている。最大実行時間は`15分`だから、それ以内で完了するタスクが適している。
2. **イベント駆動型の処理**: S3 へのファイルアップロードや DynamoDB のテーブルに変更があった場合など、特定のイベントに応じて処理を実行したい場合には向いている。
3. **スケーラビリティ**: 突発的な負荷に対して自動でスケールアップ・ダウンが可能なので、リクエストの増減に対応しやすい。
4. **コスト効率**: 実行時間に応じた課金だから、頻度が低いタスクの場合にはコストが抑えられる。
5. **管理の手間が少ない**: インフラの管理が不要で、デプロイも簡単なため、管理や運用の労力が少ない。

## 独立したバッチプログラムを Cron ジョブで実行すべきケース

1. **長時間のタスク**: 長時間にわたる処理が必要な場合（例えばバックアップや大規模データの処理など）は、Lambda だと制約があるため適していない。
2. **固定スケジュールでの実行**: 毎日決まった時間に実行するような定期的なバッチ処理には Cron ジョブが向いている。
3. **複雑な依存関係**: 他のシステムやサーバーとの複雑な依存関係がある場合、Lambda よりも専用サーバー上でのバッチ処理の方が扱いやすい場合がある。
4. **リソース利用の自由度**: CPU やメモリの使用量が大きいタスクや、特定のハードウェアが必要な場合には、自由にリソースを設定できる独立したバッチプログラムが適している。

## AWS Lambda に適した短時間の基準

### おおよその目安

- **数秒から数分**: 一般的には数秒から数分以内に完了するタスクに適している。例えば、簡単なデータベースクエリや、ファイルのフォーマット変換、通知の送信など。

### 詳細

- **最大実行時間**: AWS Lambda の最大実行時間は`15分（900秒）`。そのため、タスクがこれを超える可能性がある場合は、Lambda の利用は適していない。
- **瞬間的な負荷対応**: 突発的な負荷にも即応できるため、リクエストが一時的に増えるような Web Application のバックエンド処理などにも向いている。

### 具体的な利用シナリオ

1. **データ処理**: 小規模なデータセットのフィルタリング、集計、変換など。
2. **イベント駆動のタスク**: S3 にファイルがアップロードされたときの処理、DynamoDB のトリガー、SNS 通知の処理。
3. **API バックエンド**: API Gateway と連携して、クエリの処理や簡単なビジネスロジックの実装。
4. **リアルタイム処理**: クラウドウォッチイベントや Kinesis ストリームからのリアルタイムデータ処理。

### 注意点

- **リトライ制御**: 一部の処理が失敗する可能性があるタスクに関しては、Lambda のリトライ機能（失敗時の自動再試行）も活用できる。
- **分割して実行**: 長時間処理が必要なタスクでも、タスクを細かく分割して連続実行すれば、Lambda を利用できる場合もある。

## Lambda 以外を選択する場合

### 1. Step Functions の利用

`AWS Step Functions` は複雑なワークフローを定義し、時間のかかるタスクをステートマシンとして実行することができる。タスクを複数の小さなステップに分割し、各ステップが Lambda 関数となり、連続的に実行される形になる。これにより、15 分以上の時間がかかる処理でも、複数の Lambda 関数を組み合わせて実行できる。

### 2. SQS (Simple Queue Service) と Lambda の連携

処理を分割して SQS キューにメッセージとして投入し、それを定期的に Lambda 関数で処理する方法です。処理が終了したら次のメッセージを処理する形で、徐々に全ての処理を完了させることができる。

### 3. AWS Batch の利用

時間が非常に長くかかるバッチ処理には、AWS Batch を利用するのも一つの方法。AWS Batch は完全マネージド型のバッチ処理システムで、必要に応じてコンピュータリソースを自動でスケーリングし、バッチジョブをキューに投入、管理する。

### 4. 分散コンピューティングの利用

処理をさらに細かい粒度に分割し、Amazon EC2 や Auto Scaling グループを利用して並行処理する方法。複数の EC2 インスタンスを利用して並列にデータを処理し、結果をまとめることで時間を短縮することが可能。

### 5. Lambda 関数の再起動

長時間処理が必要な場合には、処理の状態を一時的に保存し、Lambda 関数がタイムアウトする前に次の Lambda 関数を起動して続きを実行する方法も考えられる。DynamoDB や S3 などを使って処理状況を保存し、次回の Lambda が起動した際にそれを読み取って継続処理を行う。

### 6. 外部サービスの利用

特定のタイプの処理やコンピューティングリソースが大量に必要な場合には、外部のクラウドサービスを利用することも考えられます。例えば、Google Cloud Platform や Microsoft Azure のサービスも検討する価値があります。

どのアプローチを選ぶかは、具体的な処理内容や要件に応じて異なりますので、最適な方法を選択してください。
