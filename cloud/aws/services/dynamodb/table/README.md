# DynamoDB のテーブル内のデータ構造

DynamoDB のテーブルは、次の主要な要素で構成されている

## 1. テーブル

- **テーブル**は DynamoDB でデータを格納する基本単位で、行（アイテム）の集合。
- 各テーブルには、プライマリキーが必要。

## 2. プライマリキー

プライマリキーはテーブル内のアイテムを一意に識別するためのキー。プライマリキーには以下の 2 種類存在する

- **シンプルキー（Partition Key のみ）**:

  - 一つの属性をキーとして使用します（例：`userID`）。
  - 全てのアイテムはこのキーの値で一意に識別される。

- **複合キー（Partition Key + Sort Key）**:
  - パーティションキーとソートキーの 2 つの属性で構成される。
  - パーティションキーによってデータが分割され、同じパーティションキーを持つアイテムはソートキーによって一意に識別され、順序付けされる。

```plaintext
| Partition Key | Sort Key | Other Attributes |
| ------------- | -------- | ---------------- |
| A001          | 123      | ...              |
| A001          | 124      | ...              |
| A002          | 456      | ...              |
```

## 3. 属性

各アイテムは複数の属性を持つ。属性はキーと値のペアであり、例えば以下のように定義される：

- `userID` : "user123"
- `timestamp` : "2023-01-01T00:00:00Z"
- `data` : "some data"

## 4. アイテム

- **アイテム**はテーブルの行に相当し、属性の集合。各アイテムはプライマリキーによって一意に識別される。
- DynamoDB では、アイテムは柔軟な構造を持つことができ、同じテーブル内でもアイテムごとに異なる属性を持つことができる。

```json
{
  "userID": "user123",
  "timestamp": "2023-01-01T00:00:00Z",
  "data": "some data",
  "email": "user123@example.com"
}
```

## 5. インデックス

**インデックス**は、特定の属性でデータを効率的に検索するために使用される。

- **ローカルセカンダリインデックス（LSI）**:

  - 同じパーティションキーを共有しながら、異なるソートキーを持つアイテムを効率的に検索するために使用される。
  - テーブル作成時にのみ追加可能。

- **グローバルセカンダリインデックス（GSI）**:
  - テーブルとは異なるパーティションキーとソートキーを持つことができ、テーブル作成後に追加可能。
  - 全テーブルにまたがって、別のキーを基にデータを効率的に検索できる。

```hcl
resource "aws_dynamodb_table" "example" {
  name         = "example-table"
  billing_mode = "PAY_PER_REQUEST"
  hash_key     = "partition_key"
  range_key    = "sort_key"

  attribute {
    name = "partition_key"
    type = "S"
  }

  attribute {
    name = "sort_key"
    type = "S"
  }

  global_secondary_index {
    name            = "GSI1"
    hash_key        = "GSI1PK"
    range_key       = "GSI1SK"
    projection_type = "ALL"
  }

  local_secondary_index {
    name            = "LSI1"
    range_key       = "LSI1SK"
    projection_type = "ALL"
  }
}
```

## 6. プロビジョニングされたスループット（R/W キャパシティーユニット）

**プロビジョニングされたスループット**は、秒単位での読み取りと書き込み操作のパフォーマンスを管理する。テーブルの設定に応じて、プロビジョニングモード（固定キャパシティまたはオンデマンドキャパシティ）を選択する。

## データ操作

### アイテムの作成、取得、更新、削除（CRUD 操作）

- **PutItem**: 新しいアイテムを追加
- **GetItem**: 特定のアイテムを取得
- **UpdateItem**: アイテムの特定の属性を更新
- **DeleteItem**: アイテムを削除

### クエリとスキャン

- **Query**:

  - パーティションキーに基づいて効率的にデータを検索でき、必要に応じてソートキー条件を追加できる。
  - 特定のパーティション内で複数のアイテムを取得するのに最適。

- **Scan**:
  - テーブル全体またはインデックス全体を走査してアイテムを取得する。
  - すべてのデータを一度に取得するため、負荷が高くなる可能性がある。フィルターを使用して負荷を軽減できる。

## 使用例

たとえば、ユーザーアクティビティログを保存するテーブルを構築する場合：

- **テーブル定義**:
  - パーティションキー: `userID`
  - ソートキー: `timestamp`
- **インデックス**:
  - GSI を使用して、特定のイベントタイプやその他の属性でデータを効率的に検索できるようにする。たとえば、`eventType-index` など。
