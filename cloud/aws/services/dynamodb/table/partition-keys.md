# DynamoDBで使われるパーティションキー（Partition Key）

## 概要

- **定義**:
  - パーティションキーはDynamoDBのテーブル内でデータを分散するために使用されるキー。
  - このキーはテーブルの各エントリを一意に識別するのに使われ、複数のエントリが同じパーティションキーを持つことができるが、各パーティションキーは異なるハッシュ値に変換され、このハッシュ値を基にパーティションが決定される。

- **特性**:
  - **一意性要件**:
    - `パーティションキー単独では一意である必要はない`。つまり、同じ値を持つ複数のエントリが存在することが認められる。
  - **分散**:
    - パーティションキーの値が均等に分布することが、DynamoDBのパフォーマンスを最適化する上で重要。このため、広範に散らばった範囲のパーティションキーを使用することが望ましい。

## Primary Key: ソートキー（Sort Key）と合わせて、複合キー（Composite Key）とする

- **ソートキーとの組み合わせ**:
  - DynamoDBテーブルにおいて、パーティションキーと組み合わせてソートキーを使用することができる。この組み合わせを`複合キー（Composite Key）`と呼ぶ。
  - この複合キーの場合、パーティションキーとソートキーの組み合わせが一意である必要がある。例えば、パーティションキーがユーザーID、ソートキーがタイムスタンプという構成であれば、同じユーザーIDの異なるタイムスタンプを持つエントリを格納できる。

## 実際のユースケースと例

例えば、Userデータベースの場合

- **パーティションキー単独**:
  - パーティションキー: `userID`
  - 同じ `userID` を持つエントリが存在することが許されるが、これだけだと範囲クエリが困難。

- **複合キー**:
  - パーティションキー: `userID`
  - ソートキー: `timestamp`（あるいは他の属性）
  - この組み合わせで、特定のユーザーのアクションログを時系列でソートして保存し、クエリできる。

```json
// パーティションキー（userID）
{
    "userID": "user123",
    "name": "Alice",
    "email": "alice@example.com"
},
{
    "userID": "user123",
    "name": "Bob",
    "email": "bob@example.com"
}

// 複合キー（userID + timestamp）
{
    "userID": "user123",
    "timestamp": "2023-01-01T00:00:00Z",
    "action": "login"
},
{
    "userID": "user123",
    "timestamp": "2023-01-01T01:00:00Z",
    "action": "logout"
}
```

## DynamoDBにおける設計上の考慮点

1. **キーの分散とアクセスパターン**:
   - パーティションキーの選定は非常に重要であり、均等な分布を目指すべき。例えば、データが特定のパーティションキーに偏ると、ホットパーティションと呼ばれる性能問題が起こる可能性がある。

2. **アクセスパターンに基づいた設計**:
   - DynamoDBの設計では、主にアクセスパターンを考慮してパーティショニングとIndexを構成することが重要。事前に多くのクエリパターンを予測し、それに応じたパーティションキーとソートキーを設計する。

## パーティションキー まとめ

- **パーティションキー**:
  - 値が重複しても問題ないが、広く分散させることが重要。
  - パーティションキー単独またはソートキーとの組み合わせで使用される。

- **複合キー**:
  - パーティションキーとソートキーの組み合わせで、一意性を保証しつつ複数のエントリを保存できる。

- **設計のポイント**:
  - キーの選定に当たって、均等な分散と効率的なクエリを重視する。
