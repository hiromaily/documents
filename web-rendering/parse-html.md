# HTML解析とDOMツリーの構築

## HTMLのパースとは？

HTMLのパースとは、ブラウザがHTML文書を読み取ってその内容を理解し、内部的に操作可能なデータ構造に変換するプロセスのことを指す。HTML文書は通常、テキストファイルとして保存されているため、そのままではブラウザが直接扱うことができない。このため、HTMLを解析して`DOM (Document Object Model) ツリー`という形式に変換する。

## パースと解析の具体的な手順

### 1. トークン化 (Tokenization)

- **入力ストリームの読み取り**: ブラウザはHTML文書を一文字ずつ順番に読み取る。
- **トークンの生成**: 読み取った文字を基に、タグや属性、テキストノードなどの構成要素をトークンと呼ばれる単位に分割する。例えば、`<div class="example">`という文字列があった場合、`<div>`, `class`, `=`, `"example"` の各部分がトークンに対応する。

### 2. トークンの分類 (Token Classification)

- **タグの識別**: トークンが開始タグか終了タグ、または自閉タグ（`<img />`のような）であるかを判別する。
- **属性の識別**: タグ内に定義されている属性名とその値を識別する。これにより、各タグがどのような属性を持つかを理解する。

### 3. ノードの生成 (Node Generation)

- **ノードの作成**: トークンから対応するノード（要素ノード、テキストノードなど）を生成する。
- **ツリー構造の組み立て**: 各ノードを適切な親子関係に配置し、ツリー構造を形成する。例えば、`<div><p>Text</p></div>`の場合、`<div>`が親ノードで`<p>`がその子ノード、`Text`がさらにその子ノードとなる。

### 4. エラーハンドリング (Error Handling)

- **エラーの検出と修正**: HTML文書が完全ではない場合（例えば、閉じタグが欠落している場合）でも、ブラウザはできるだけ意図されたドキュメント構造を維持するようにエラーを修正する。ブラウザごとに若干の違いはあるが、一般的には仕様に基づいたルールを使用してエラーを処理する。

## 実際の例

以下に簡単なHTML文書を例にして、パースの流れを説明する。

```html
<!DOCTYPE html>
<html>
<head>
  <title>Example Page</title>
</head>
<body>
  <div class="container">
    <p>Hello, World!</p>
  </div>
</body>
</html>
```

### ステップ1: トークン化

- `<!DOCTYPE html>`: ドクトタイプ宣言トークン
- `<html>`: 開始タグトークン
- `<head>`: 開始タグトークン
- `<title>`: 開始タグトークン
- `Example Page`: テキストトークン
- `</title>`: 終了タグトークン
- `</head>`: 終了タグトークン
- `<body>`: 開始タグトークン
- `<div class="container">`: 開始タグトークン
- `<p>`: 開始タグトークン
- `Hello, World!`: テキストトークン
- `</p>`: 終了タグトークン
- `</div>`: 終了タグトークン
- `</body>`: 終了タグトークン
- `</html>`: 終了タグトークン

### ステップ2: トークンの分類

- 各トークンがタグ、属性、テキストなどに分類される。

### ステップ3: ノードの生成

- 各トークンに対応するノードが生成され、適切なツリー構造に配置される。例えば、`<div class="container">`は`div`要素ノードとなり、その属性`class="container"`も対応する属性ノードとして保持される。

### ステップ4: エラーハンドリング

- この例ではエラーはないが、もし`</p>`のタグがなかった場合など、ブラウザが適切に修正してツリー構造を維持する。
