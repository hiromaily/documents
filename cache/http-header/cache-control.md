# HTTP Header `Cache-Control`

`Cache-Control`ヘッダーは、HTTPリクエストやレスポンスにおいてキャッシュの振る舞いを指定するために使用される。これにより、ブラウザや中間キャッシュ（プロキシサーバーなど）がレスポンスをどのようにキャッシュし、どのタイミングで再検証を行うかを制御できる。
また、Cache-Controlヘッダーは、HTTPリクエストとHTTPレスポンスの両方で使用できる。

## Cache-Controlヘッダーのディレクティブ

### 1. `max-age`

リソースがキャッシュされる最大期間（秒単位）を指定する。

```http
Cache-Control: max-age=3600
```

上記の例では、このリソースは1時間（3600秒）キャッシュされる。

### 2. `no-cache`

キャッシュは許可するが、再利用する前に必ずオリジンサーバーにリソースの最新状態を確認する。

```http
Cache-Control: no-cache
```

### 3. `no-store`

リソースをキャッシュストレージに保存しない。機密情報など、一切キャッシュしてはいけないデータに使用。

```http
Cache-Control: no-store
```

### 4. `must-revalidate`

キャッシュが期限切れになった場合、必ずオリジンサーバーにリソースを再確認する必要がある。

```http
Cache-Control: must-revalidate
```

### 5. `public` と `private`

- `public`：リソースがどんなキャッシュストレージでもキャッシュ可能であることを示す。
- `private`：リソースが個人的なユーザーに特化されており、中間キャッシュではキャッシュされない。

```http
Cache-Control: public, max-age=600
Cache-Control: private, max-age=600
```

### 6. `s-maxage`

中間キャッシュ（プロキシサーバー）専用のキャッシュ有効期間を指定する。他のキャッシュディレクティブより優先される。

```http
Cache-Control: s-maxage=300
```

## HTTPレスポンスの`Cache-Control`

レスポンスにおける`Cache-Control`ヘッダーは、サーバーがクライアントおよび中間キャッシュ（例えば、プロキシサーバー）に対してキャッシュの指示を与えるために使用される。

```http
HTTP/1.1 200 OK
Content-Type: application/json
Cache-Control: max-age=3600, public

{
  "id": 1,
  "name": "Example Resource"
}
```

- `max-age=600`
  - レスポンスがクライアントとプロキシキャッシュで3600秒（1時間）キャッシュされる
- `public`
  - リソースは中間キャッシュでもキャッシュ可能

### HTTPレスポンスで使われるディレクティブ

- `max-age=<seconds>`：キャッシュの最大有効期間を秒単位で指定。
- `public`：リソースがどんなキャッシュストレージでもキャッシュ可能。
- `private`：リソースが個人的なユーザーに特化されており、中間キャッシュではキャッシュされない。
- `no-store`：キャッシュに保存しない。
- `no-cache`：キャッシュは許可するが、再利用する前に必ずオリジンサーバーにリソースの最新状態を確認する。
- `must-revalidate`：キャッシュが期限切れになった場合、必ずオリジンサーバーにリソースを再確認する。
- `s-maxage=<seconds>`：プロキシキャッシュに対してのみ有効期間を指定。

## HTTPリクエストの`Cache-Control`

リクエストにおける`Cache-Control`ヘッダーは、クライアントがリソースのリクエストに対してキャッシュの扱いを指定したい場合に使用される。

```http
GET /resource/1 HTTP/1.1
Host: example.com
Cache-Control: no-cache
```

- `no-cache`
  - キャッシュを使わず、必ずオリジンサーバーからの最新のデータを取得する。

この例では、リクエストを行うクライアントが、キャッシュされたリソースではなく、オリジンサーバーから新鮮なリソースを取得するように要求している。

#### HTTPリクエストで使われるディレクティブ

- `no-cache`：キャッシュされたリソースではなく、オリジンサーバーから常に最新のリソースを取得するよう要求。
- `no-store`：キャッシュに一切保存しない。
- `max-age=<seconds>`：特定の秒数より古いキャッシュは使用しない。
- `max-stale[=<seconds>]`：指定された秒数まで期限切れのキャッシュを許可。
- `min-fresh=<seconds>`：特定の秒数以内に期限切れになるキャッシュを使用しない。

## `Cache-Control`を使った具体例

### 1. ブラウザキャッシュの例

リソースを1時間（3600秒）キャッシュし、その後には再確認が必要になる設定：

```http
Cache-Control: max-age=3600, must-revalidate
```

これは、リソースが1時間キャッシュされ、その後再度アクセスする際にはオリジンサーバーに変更がないか確認される。

### 2. 機密情報の例

リソースを全くキャッシュしない設定：

```http
Cache-Control: no-store
```

これは、リソースがキャッシュに保存されず、常に新しいレスポンスが取得されることを保証する。

### 3. 公共キャッシュの例

リソースを10分（600秒）間キャッシュし、プロキシサーバーでもキャッシュ可能にする設定：

```http
Cache-Control: public, max-age=600
```

これはリソースが10分間キャッシュされ、一般ユーザーによるアクセスだけでなく、中間プロキシでもキャッシュできる。

### 4. 特定のプロキシキャッシュの例

プロキシサーバーに対してのみ5分（300秒）間キャッシュさせ、クライアントブラウザには10分間キャッシュさせる設定：

```http
Cache-Control: private, max-age=600, s-maxage=300
```

これはブラウザ側では10分間キャッシュさせつつ、プロキシサーバー側でのキャッシュは5分間に制限する。

## Cache-Controlのメリット

`Cache-Control`ヘッダーを適切に設定することで以下のメリットが得られる：

- **パフォーマンス向上**：クライアントがキャッシュを活用することで、データの再取得を避け、レスポンスタイムを短縮できる。
- **帯域幅の節約**：同じデータを何度も送信する必要がなくなり、ネットワーク帯域の使用を削減できる。
- **サーバー負荷の軽減**：頻繁にアクセスされるデータがキャッシュされることで、サーバーへのリクエスト数が減少し負荷が軽減される。
