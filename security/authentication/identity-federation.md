# Identity Federation

アイデンティティフェデレーション（Identity Federation）とは、異なるドメインやシステム間でユーザーのアイデンティティ（身元）情報を共有し、相互に認証できる仕組みのこと。アイデンティティフェデレーションを利用することで、ユーザーは複数のシステムやサービスに対して同じ認証情報（例：同じユーザーアカウント）でアクセスできるようになる。これにより、ユーザーエクスペリエンスの向上と管理の簡素化が図られる。

アイデンティティフェデレーションは、複数のドメインやサービス間でのシームレスなユーザー認証を可能にする強力な仕組み。これにより、ユーザーエクスペリエンスとセキュリティが向上する一方で、管理者は認証情報を一元管理しやすくなる。SAML、OAuth 2.0、OpenID Connect などの標準プロトコルをサポートすることで、多様なシナリオに対応できるアイデンティティフェデレーションは、モダンな認証インフラの中核を担っている。

## アイデンティティフェデレーションの基本概念

1. **アイデンティティプロバイダー（Identity Provider, IdP）**:

   - ユーザーの認証を行い、ユーザーのアイデンティティ情報を保持する主体。企業のシングルサインオン（SSO）システムや外部のソーシャルログインサービス（例：Google、Facebook）がこれに該当する。

2. **サービスプロバイダー（Service Provider, SP）**:

   - 受け取ったアイデンティティ情報を利用して、ユーザーにサービスやリソースを提供する主体。例：Web アプリケーション、クラウドサービス。

3. **フェデレーションプロトコル**:
   - アイデンティティ情報を安全に共有するためのプロトコル。代表的なプロトコルに`SAML（Security Assertion Markup Language）`、`OAuth 2.0`、および`OpenID Connect（OIDC）`がある。

## アイデンティティフェデレーションのフロー

### 1. ユーザーの認証

1. **ユーザーが SP にアクセス**:

   - ユーザーはまずサービスプロバイダー（SP）のサイトにアクセスする。SP はユーザーが認証されているかどうかを確認する。

2. **認証要求のリダイレクト**:

   - ユーザーが未認証の場合、SP はユーザーを認証のためにアイデンティティプロバイダー（IdP）にリダイレクトする。

3. **IdP での認証**:
   - IdP はユーザーが既に認証されているか確認する。未認証の場合、ユーザーは IdP でログインを行う（例：ユーザー名とパスワード、または他の認証方法を使用）。

### 2. トークンの発行と受け渡し

1. **認証トークンの発行**:

   - IdP はユーザーが認証された後、アイデンティティ情報を含む認証トークン（例：SAML アサーション、OAuth 2.0 アクセストークン、OIDC ID トークン）を生成する。

2. **トークンの SP へのリダイレクト**:
   - IdP は認証トークンをユーザーのブラウザ経由で SP にリダイレクトする。（例：ブラウザのリダイレクト URL にトークンを含める）

### 3. トークンの検証とアクセスの許可

1. **トークンの検証**:

   - SP は受け取ったトークンの署名や内容を検証し、認証情報が正当であるかチェックする。

2. **ユーザー情報の取得とセッションの開始**:
   - トークンが有効であれば、SP はユーザー情報を取得し、ユーザーのセッションを開始する。これにより、ユーザーは SP のサービスやリソースにアクセスできるようになる。

## アイデンティティフェデレーションのメリット

1. **ユーザーエクスペリエンスの向上**:

   - ユーザーは一度の認証（シングルサインオン）で複数のシステムやサービスにアクセスできるため、煩雑なログインプロセスが減少する。

2. **管理の簡素化**:

   - 管理者は集中管理された IdP を通じて、ユーザーアカウントや認証ポリシーを一元管理できるようになる。これにより、アカウント管理や認証プロセスが簡素化される。

3. **セキュリティの向上**:

   - セキュリティポリシーや認証方法を IdP で統一することで、全体的なセキュリティが向上する。また、パスワード管理の複雑さを減少させ、フィッシングやパスワード再利用のリスクを低減する。

4. **柔軟性**:
   - 異なる IdP と SP 間での連携が容易になるため、新しいサービスの導入や変更が柔軟に行える。

## アイデンティティフェデレーションのプロトコル

1. **SAML（Security Assertion Markup Language）**:
   - XML ベースの標準プロトコルで、主にエンタープライズ環境で使用される。IdP と SP 間で認証と認可の情報を交換する。
2. **OAuth 2.0**:

   - アクセストークンの発行と使用により、リソースへのアクセスを制御するプロトコル。OpenID Connect（OIDC）は OAuth 2.0 の上に認証機能を追加したプロトコル。

3. **OpenID Connect（OIDC）**:
   - OAuth 2.0 の上に構築され、ユーザー認証を行うための標準プロトコル。ID トークンを使用してユーザーの認証情報を提供する。
