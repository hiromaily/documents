# InfluxDB

InfluxDBは`時系列データベース`の一種であり、特にIoTから得られる大量のセンサーデータやDevOpsでクラスタリングされたサーバのメトリクス・ログを効率的に扱うために設計されている。
データはtimestampで識別される。RDBでいう主キーがtimestamp。時系列に沿ったデータを効率的な操作で管理する。

## **主な特徴**

1. **高い書込・読込スループット**: InfluxDBは大量データの書き込みと読み込みを高速に行えるデータベース。
2. **大量データの削除**: 古いデータを効率的に削除できるため、ストレージの容量を管理することができる。
3. **データの更新と削除よりも、登録と参照のパフォーマンスを優先**: InfluxDBはデータの登録と参照を高速化するため、データの更新と削除よりもこれらの処理を優先している。
4. **独自のストレージエンジン**: 2015年10月に開発された`Time-Structured Merge Tree (TSM)`を使用しており、これは時系列データに特化したストレージエンジン。

## 構成される要素

InfluxDBの内部構成は時系列データに特化しており、以下の要素で構成される。

1. **ポイント (Points)**: InfluxDBが保存する基本単位。RDBでいうレコードに相当する。ポイントは4つの要素で構成される。
   - **メジャメント (Measurement)**: データを関連付けるRDBでいうテーブルに相当するもので、Pointをグルーピングするもの。
     - しかし、MeasurementはPointに含まれる要素となる。
   - **タイムスタンプ (Timestamp)**: データの時刻を表すが、RDBでいう主キーに相当する。
   - **タグセット (Tagset)**: キーバリューのペアで構成され、データに追加の情報を付与する。Index用のデータとして利用される。
     - string型のみ。普遍な共通情報、例えばサーバー名など。
   - **フィールドセット (Fieldset)**: 型付きのデータ。RDBでいうカラムに相当する。例えば、温度値またはCPU使用率など。

2. **シリーズ (Series)**: 時系列データに対応し、TimeSeriesとそれが属するシャードに関連する基礎的な属性を格納する。以下の情報が含まれる
   - **キー**: 対応する測定+タグのシリアル化された文字列。
   - **タグ**: Timeseriesの下にあるすべてのタグキーとタグ値。
   - **ID**: 一意の整数 ID。
   - **測定**: シリーズが属する測定。
   - **シャードIDs**: シリーズを含むすべてのShard IDのリスト。

3. **シャード (Shards)とシャードグループ (Shard Groups)**:
   - **シャード**: データをストレージに格納する際に使用されるユニット。
   - **シャードグループ**: 複数のシャードがグループ化されており、バケットのデータを管理する。

4. **インデックスデータの構造**: InfluxDBでは、インデックスデータは`WAL (Write-Ahead Log)`にまず書き込まれ、後にメモリベースのインデックス構造に入る。一定のサイズに達すると、WALのデータはIndexFileにフラッシュされる。このIndexFileは、測定からタグキーへのマップ、タグキーからタグ値へのマップ、タグ値からTimeSeriesへのマップを含み、クエリを高速化する。

![influxdb](https://github.com/hiromaily/documents/raw/main/images/influxdb-structure.png "influxdb")

## **クエリ言語**

InfluxDB 1.xでは`InfluxQL`が使用されるが、InfluxDB 2.xでは`Flux`が使用される。`Fluxは関数型のパラダイムを取り入れたクエリ言語`であり、SQLに似ているが、特に時系列データの取得に適している。

## **Fluxの基本**

Fluxでは、`from`, `range`, `filter`の3つの関数を使用してデータを取り出すのが基本。例えば、以下のコードは特定のバケットから1年前からのデータを抽出し、特定のタグを持つデータをフィルタリングする。

```flux
from(bucket: "bucket-name")
|> range(start: -1y)
|> filter(fn: (r) => r.tag == "t1")
```

## **クライアントインタフェース**

InfluxDBには2つのインタフェースが用意されている

1. **CLI**: コマンドラインインタフェースで、シェルから`influx`コマンドを使用する。
2. **REST API**: HTTPリクエストを使用してデータにアクセスする。クエリ結果はJSONやCSV形式で取得できる。

## ストレージとライセンス

InfluxDBは`Golang`で書かれており、MITライセンスのオープンソースソフトウェア。各種OS向けのバイナリが提供されている。

### バージョンアップデート

最近のバージョンであるInfluxDB 3.0 (Jun 2025時点ではalpha)では、リアルタイム処理能力が高く、データフォーマットに`Apache Parquet`を採用し、ストレージコストが大幅に削減されている。

## 類似の時系列データベース

- OpenTSDB
- KairosDB
- Prometheus
- DalmatinerDB
