# MongoDB

MongoDB は、スキーマレスなデータモデルを採用した NoSQL データベースであり、高い柔軟性とスケーラビリティを持っている。
MongoDBはスキーマレスなデザインにより、柔軟なデータモデルを提供し、階層的データや変動するデータ属性を持つユースケースに非常に適している。高いスケーラビリティと可用性が要求されるアプリケーションに理想的な選択。具体的なユースケースに応じて最適な方法でデータをモデル化し、クエリ・インデックス・運用上のベストプラクティスを取り入れることが重要。

## MongoDB の特徴

1. **ドキュメント指向ストレージ**:

   - データを JSON ライクなドキュメント形式（BSON 形式）で保存。
   - フレキシブルなスキーマを使用し、異なる構造のデータを同じコレクションに保存できる。

2. **スキーマレスデザイン**:

   - データのスキーマを事前に定義する必要がなく、柔軟にデータモデルを変更することができる。

3. **高いスケーラビリティ**:

   - 水平スケーリングが容易で、シャーディングによって大規模データを効率的に管理できる。

4. **リッチなクエリ言語**:

   - 強力なクエリ機能、インデックス、アグリゲーションフレームワークを提供。

5. **分散とレプリケーション**:
   - 高可用性を確保するためのレプリカセットおよびデータ冗長性。

## MongoDB の基本構造

- **データベース (Database)**:

  - 複数のコレクションを持つ単位。

- **コレクション (Collection)**:

  - 同種のドキュメントを格納する。RDBMS でいうテーブルに相当。

- **ドキュメント (Document)**:

  - 実際のデータを格納します。BSON 形式のキーと値のペアで表現される。

- **フィールド (Field)**:
  - ドキュメント内の要素。キーと値のペアで構成される。

## 基本的な操作

### 配置と接続

MongoDB のインストール後、MongoDB サーバーを`mongod`コマンドで起動し、`mongo`シェルを使って接続する。

```sh
# サーバー起動
mongod

# シェル起動
mongo
```

### データベースの作成と使用

データベースを作成し、使用するには次のコマンドを使用する。

```js
# データベースの選択（存在しなければ作成される）
use exampleDB
```

### コレクションの作成

コレクションは、データを挿入する際に自動で作成される。

```js
# データの挿入とコレクションの自動作成
db.exampleCollection.insertOne({ name: "Alice", age: 25, deleted: false })
```

### データの挿入

複数のドキュメントを挿入する場合は`insertMany`を使用する。

```js
db.exampleCollection.insertMany([
  { name: "Bob", age: 28, deleted: false },
  { name: "Charlie", age: 32, deleted: true },
]);
```

### データのクエリ

基本的なクエリには`find`メソッドを使用する。`find`はフィルタリング条件を指定してドキュメントを検索する。

```js
# 全てのドキュメントを取得
db.exampleCollection.find({})

# 条件に基づくドキュメントを取得
db.exampleCollection.find({ age: { $gt: 25 } })

# 削除されていないユーザーを取得
db.exampleCollection.find({ deleted: false })
```

### データの更新

データの更新には`updateOne`や`updateMany`を使用できる。

```js
# 単一のドキュメントを更新
db.exampleCollection.updateOne(
  { name: "Alice" },
  { $set: { age: 26, deleted: true } }
)

# 複数のドキュメントを更新
db.exampleCollection.updateMany(
  { deleted: false },
  { $set: { age: 29 } }
)
```

### データの削除（論理削除）

物理削除を行う代わりにフラグを使って論理削除を行うことが推奨される。

```js
# 論理削除のフラグを設定
db.exampleCollection.updateOne(
  { name: "Bob" },
  { $set: { deleted: true } }
)
```

## インデックスとパフォーマンス

クエリパフォーマンスを向上させるために、インデックスを作成できる。

```js
# フィールドにインデックスを作成
db.exampleCollection.createIndex({ age: 1 })
```

## アグリゲーションフレームワーク

データの集計を行うには、アグリゲーションパイプラインを使う。

```js
db.exampleCollection.aggregate([
  { $match: { deleted: false } },
  { $group: { _id: "$age", total: { $sum: 1 } } },
]);
```

## レプリケーションとシャーディング

- **レプリケーション**: レプリカセットを構成し、データの冗長性と可用性を向上させます。
- **シャーディング**: データを分散してスケーラビリティを確保。シャードキーに基づきデータを複数のシャードに分割します。

## MongoDBのライセンス

MongoDBは、過去にいくつかのライセンス変更が行われてきた。現在、MongoDBは`Server Side Public License（SSPL）`を採用。

### Server Side Public License（SSPL）

- **導入時期**: 2018年10月にMongoDB, Inc.はSSPLを公開。
- **概要**: SSPLはオープンソースライセンスであり、GNU Affero General Public License v3（AGPL）の改訂版として設計された。SSPLは、クラウドサービスプロバイダーをターゲットにしており、MongoDBをサービスとして提供する場合に特別な要件がある。

### SSPLの主要要件

- **オープンソースの要求**: SSPLは、自身のコードを変更して配布する場合、変更内容やそのコードに関連するすべてのコードの公開を義務付けている。
- **サービス提供の制約**: SSPLの主要な特徴の一つは、MongoDBをサービスとしてユーザーに提供する場合、提供側はそのソースコードやそれに関連する運用インフラのコードもオープンソースにする必要があるという点。

### SSPLの問題点と批判

- **オープンソースコミュニティ**: SSPLは、一部のコミュニティからオープンソースの精神を逸脱しているという批判を受けている。このため、オープンソースイニシアチブ（OSI）から公式に承認されていない。
- **クラウドプロバイダー**: クラウドサービスプロバイダーに対して、MongoDBを商業利用する際に制限を設けることを目的としているため、必然的にクラウドプロバイダーにとって非商用的な使用が難しくなる。

### 代替案

オープンソースのMongoDB互換データベースを探している場合、以下の代替案がある。

1. **Amazon DocumentDB**
   - Amazon Web Services (AWS) によるMongoDBとの互換性を持つマネージドデータベースサービス。

2. **Percona Server for MongoDB**
   - Perconaによってメンテナンスされている、MongoDBと互換性のあるオープンソースデータベース。
   - ライセンスはGNU AGPL v3。

3. **TokuMX**
   - Tokutekによって開発された、MongoDBのフォーク版。高性能なトランザクションと圧縮機能が特徴。
