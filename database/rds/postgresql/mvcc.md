# [同時実行制御: MVCC](https://www.postgresql.jp/document/16/html/mvcc.html)

PostgreSQL における同時実行制御（Concurrency Control）は、主に MVCC（Multi-Version Concurrency Control）と呼ばれる仕組みによって実現されている。MVCC は、高いパフォーマンスを維持しつつ、複数のユーザーが同時にデータベースへアクセスできるようにするための技術。

## MVCC の基本概念

### 1. 複数バージョンのデータ保存

PostgreSQL では、データベース内のテーブルに対する操作（INSERT、UPDATE、DELETE）を行うたびに、各行（レコード）の新しいバージョンが作成される。古いバージョンのデータは保持されており、これによって異なるトランザクションが同時に異なるバージョンのデータを読み取り、操作できるようになる。

### 2. トランザクション ID（Transaction ID）

各トランザクションにはユニークな識別子（Transaction ID）が付与される。各データ行には、いつその行が挿入され（xmin）いつ削除または更新されるか（xmax）が記録されている。(Insertion ID, xmin; and deletion/update ID, xmax).

### 3. スナップショットの取り方

各トランザクションは開始時にスナップショットを取得し、自身の読み取り操作を行う。このスナップショットには、その時点で有効と判断された全ての行のバージョンが含まれている。他のトランザクションによって行われた変更は、スナップショット取得後に完了していない限り、そのトランザクションの視点からは見えない。

## MVCC の動作例

1. **トランザクション A が SELECT**
   投稿済みのデータは、トランザクション A が開始された時点のスナップショットに従って返される。このため、他のトランザクションによる新しいバージョンのデータは見えない。

2. **トランザクション B が UPDATE**
   トランザクション B がデータ行を更新すると、その行の新しいバージョンが作成される。古いバージョンは保持され、トランザクション B が完了するときに変わる。

3. **トランザクション A が続く SELECT**
   トランザクション A は開始時のスナップショット状態を見ているため、トランザクション B が行った更新は見えない。

4. **トランザクション B が COMMIT**
   トランザクション B の新しいバージョンが他のトランザクションから見えるようになる。ただし、トランザクション A が未だに動作中の場合、そのスナップショットは変更されることはない。

## ガベージコレクション

古いデータバージョンを無制限に保持すると、ストレージの無駄が発生する。PostgreSQL では、VACUUM プロセスを通じて不要な古いデータバージョンを削除し、ストレージを効率的に管理している。

## MVCC の利点

- **高い可用性とパフォーマンス**: 競合が少なく、ウェイトが発生しにくい。
- **一貫性**: 各トランザクションは自身のスナップショットに基づいて読み取り、一貫したデータの視点を提供。
- **スケーラビリティ**: 多くのユーザーが同時にデータベースを利用しても、性能を維持しやすい。

MVCC はデータベースの同時実行性を高めるための強力な技術であり、PostgreSQL はその優れた実装によって、多くのアプリケーションで採用されている。
