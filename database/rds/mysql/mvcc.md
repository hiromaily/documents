# 同時実行制御: MVCC

MySQL も PostgreSQL 同様に、同時実行制御を管理するための方法として MVCC（Multi-Version Concurrency Control）を採用している。ただし、具体的な実装や細かい動作は PostgreSQL と異なる部分がある。

## MySQL の MVCC 概要

MySQL では、特に InnoDB ストレージエンジンが MVCC をサポートしている。

### 1. データバージョンの保存

各テーブルの行には、隠された 2 つのカラムが含まれており、これによって行が作成された時と削除された時のトランザクション ID が記録される。この情報を基に、MySQL は特定のトランザクションがどのバージョンのデータを利用できるかを判断する。

### 2. トランザクション ID（Transaction ID）

InnoDB では、各トランザクションは内部的に一意のトランザクション ID を持つ。このトランザクション ID は、行が作成または変更された時に付与される。

### 3. 一貫性のあるスナップショット

トランザクションが開始されると、InnoDB は現在有効なスナップショットを取得する。このスナップショットは、開始時点でコミットされていた変更のみを含む。その後の変更は、トランザクションが完了するまでそのトランザクションからは見えない。

## 具体的な動作例

1. **トランザクション A が SELECT**
   トランザクション A が開始された時点のスナップショットに従ってデータが返される。開始後の変更は見えない。

2. **トランザクション B が UPDATE**
   トランザクション B がデータ行を更新すると、その行の新しいバージョンが作成される。古いバージョンはそのまま保持され、この新しいバージョンはトランザクション B が完了するまで他のトランザクションには見えない。

3. **トランザクション A が再度 SELECT**
   トランザクション A は依然として開始時点のスナップショットに基づいているため、トランザクション B の変更は見えない。

4. **トランザクション B が COMMIT**
   トランザクション B がコミットされると、その変更は以降の新しいトランザクションから見えるようになる。ただし、トランザクション A は完了するまで変わらない。

## ガベージコレクション

InnoDB では古いデータバージョンを自動的にクリーンアップするメカニズムがある。不要になったデータバージョンは、バックグラウンドスレッドによって自動的に削除される。このプロセスは「Purging（パージ）」と呼ばれる。

## MVCC の利点

- **高い可用性とパフォーマンス**: 競合を避け、トランザクションの待ち時間を減少。
- **一貫性**: 各トランザクションは自身のスナップショットに基づいているため、データの一貫性を保証。
- **スケーラビリティ**: 多数のユーザーが同時にデータベースを利用しても、良好な性能を維持。

## 関連のトランザクション分離レベル

MySQL は以下の 4 つのトランザクション分離レベルをサポートしている。これにより、特定の動作保証や性能要件に応じた選択が可能。

1. **READ UNCOMMITTED**: 他のトランザクションが未コミットのデータも読み取ることができる。
2. **READ COMMITTED**: 他のトランザクションがコミットした変更のみを読み取ることができる。
3. **REPEATABLE READ**: トランザクション中に一貫性のあるスナップショットを保持する。これが InnoDB のデフォルト設定。
4. **SERIALIZABLE**: 全てのトランザクションが直列的に実行されるように見える最も厳格なレベル。

InnoDB のデフォルトのトランザクション分離レベルは「REPEATABLE READ」であり、これによって多くの一般的なユースケースで十分な一貫性と性能バランスを達成している。
