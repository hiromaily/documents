# ストアドプロシージャ Stored Procedure

ストアドプロシージャ（Stored Procedure）は、データベース内に保存され、再利用可能なプログラムコードのことを指す。SQL（構造化照会言語）を使って書かれたもので、一連のSQLステートメントを1つの論理単位としてまとめたもの。これにより、複雑な操作をシンプルに実行することが可能になる。

データベースを効率的に操作し、メンテナンスとセキュリティを向上させるための強力なツール。各データベースシステム（例：MySQL、PostgreSQL、SQL Server、Oracleなど）では、ストアドプロシージャの記述方法や機能が若干異なる。

## ストアドプロシージャの利点

1. **再利用性**:
　　一度作成したストアドプロシージャは、何度でも呼び出して使用できる。

2. **パフォーマンスの向上**:
　　ストアドプロシージャは一度コンパイルされてデータベースに保存されるため、実行時のパフォーマンスが向上する。

3. **メンテナンス容易性**:
　　SQLコードを集中管理できるため、バグ修正やアップデートが容易になる。

4. **セキュリティ**:
　　ユーザに対して直接テーブルへのアクセス権を与えることなく操作を行わせることができるため、セキュリティが向上する。

## ストアドプロシージャの管理

1. **作成**:
　　`CREATE PROCEDURE`文を使って作成する。

2. **更新**:
　　`ALTER PROCEDURE`文を使って既存のストアドプロシージャを変更する。

3. **削除**:
　　使わなくなったストアドプロシージャは`DROP PROCEDURE`文で削除できる。

4. **実行**:
　　`EXEC`または`CALL`を用いて実行する。データベースシステムにより異なる。

## ストアドプロシージャの種類

1. **入力パラメータあり**:
　　外部からの入力を受け取り、それに応じて処理を行う。

2. **出力パラメータあり**:
　　結果を呼び出し元に返す。

3. **トランザクション制御機能**:
　　複数のSQLステートメントを1つのトランザクションとしてまとめることができる。

## Functionとの違い

`ストアドプロシージャ（Procedure）`と`関数（Function）`は、データベース管理システム（DBMS）においてスクリプトやロジックを実行するための主要な手法だが、それぞれ異なる特性や用途がある。また、Functionについては多くのDBMSがサポートしているが、詳細はDBMSによって異なる。

`関数`は通常、SQLステートメント内でのデータ変換や計算に使用される一方、`ストアドプロシージャ`は主にトランザクション制御や複雑なビジネスロジックの実行に使用される。また、多くの主要なDBMSが関数をサポートしているため、データベースに依存しない一般的な機能として利用できる。

### 1. 戻り値の有無

- **関数**：
  - 戻り値が必須。
  - 戻り値は通常1つ（スカラー値またはテーブル）で、呼び出し元で直接利用可能。
  - SQLクエリ内で使われることが多い。
  - 例：「SELECT関数を使用して結果をフィルタリング」

    ```sql
    SELECT * FROM employees WHERE calculate_bonus(employee_id) > 500;
    ```

- **ストアドプロシージャ**：
  - 戻り値が不要な場合もある。
  - 複数の戻り値を出力パラメータとして返すことが可能。
  - 主にデータの変更や複雑なビジネスロジックの実行に使用される。
  - 例：「データベースの更新処理」

    ```sql
    CALL increment_salary(101, 500);
    ```

### 2. 使用場所

- **関数**：
  - 他のSQLステートメント内で直接呼び出すことができる。（例：SELECT、INSERT、UPDATE、DELETE）
  - 一般的にデータの計算や変換に使用される。

- **ストアドプロシージャ**：
  - 独立した`CALL`文で呼び出される。
  - より大規模な処理やバッチ処理、トランザクション制御が必要な場面で使用される。
  - トリガー内で呼び出すこともできるが、他のSQLステートメント内で直接利用できない場合が多い。

### 3. トランザクション制御

- **関数**：
  - 一般にトランザクション制御（COMMIT、ROLLBACK）は行えない。

- **ストアドプロシージャ**：
  - トランザクション制御を含めることができる。
  - 複数のクエリや操作を一つのトランザクションとしてまとめることが可能。

### 4. パフォーマンス

- **関数**：
  - コストが低く、特に読み取り専用の操作で効率的。

- **ストアドプロシージャ**：
  - 複雑なビジネスロジックや大量の書き込み操作に適している。
