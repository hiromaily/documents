# 分散トレーシングで使われる用語

分散トレーシングにおいて、`Span`および`Tag` (他のシステムでは`Attribute`や`Label`と呼ばれることもある) は中心的な概念。これらの機能は、システム内のリクエストのフローを詳細に追跡し、パフォーマンスやトラブルシューティングの情報を収集するために使用される。

## 1. Span (スパン)

Spanは分散トレーシングの基本単位で、特定の操作やタスクの実行期間を表す。分散システムにおける各リクエストのライフサイクルを追跡するために使用される。

### Spanの主要な特徴

1. **Span ID**:
   - 各Spanは一意のID（識別子）を持ちます。これにより個々の操作やタスクを一意に識別できる。

2. **Trace ID**:
   - SpansはTraceという大きなコンテキストの一部です。Trace IDは全ての関連するSpanを一つのリクエストのフローとしてまとめるための識別子。

3. **Parent Span ID**:
   - Spanは階層構造で表現されることが多く、親子関係を持ちます。Parent Span IDは現在のSpanの親Spanを示す。

4. **開始時間と終了時間**:
   - Spanは特定の時間範囲をカバーします。タイムスタンプが開始時と終了時に記録されることで、処理の持続時間が計測される。

5. **名前（Operation Name）**:
   - 各Spanには操作の名前が付けられており、どのような操作が行われたのかを示します。たとえば「HTTP GET /api/resource」など。

## 2. Tag/Attribute/Label (タグ)

Tag（またはAttribute、Label）は、Spanに付加情報を追加するために使用される。タグはキーとバリューのペアで構成され、Spanに関するさまざまなメタデータを記録する。

### Tagの例

1. **HTTP関連のタグ**:
   - `http.method`: HTTPリクエストのメソッド（例：GET, POST）
   - `http.url`: リクエストされたURL
   - `http.status_code`: HTTPステータスコード

2. **データベース関連のタグ**:
   - `db.system`: データベースの種類（例：mysql, postgresql）
   - `db.statement`: 実行されたSQLクエリ
   - `db.operation`: 実行された操作（例：SELECT, INSERT）

3. **汎用的なタグ**:
   - `error`: エラーの発生を示す真偽値
   - `component`: 操作を実行したソフトウェアコンポーネント

## 3. Span Logs/Events (スパン ログ/イベント)

Spanはそのライフサイクル中に発生した特定のイベントやログメッセージを記録することもできる。これらは時系列の詳細な情報を提供し、問題の診断やデバッグに役立つ。

### Span Logs/Eventsの特徴

- **タイムスタンプ**: 各イベントはタイムスタンプを持ち、いつ発生したかを示す。
- **イベント名**: イベントの名前を指定し、どのような種類のイベントが発生したかを示す。
- **属性**: イベントに付加情報を追加するための属性を持つことができる。

## 4. Baggage

Baggageは、サーバー間をまたいで伝播されるキーとバリューのペアのセット。これにより、分散コンテキスト全体で共有されるデータを保持することができる。

### Baggageの使用例

- **ユーザー情報**: リクエストが複数のマイクロサービスを通過する際に、ユーザーのIDや権限情報などを伝播させることができる。
- **トランザクション情報**: 特定のトランザクションやセッションに関する詳細情報を保持し、関連するすべてのサービスに伝えることが可能。

## 検索方法 (重要)

この情報は、[分散トレーシング](../distributed-tracing.md)側にも記載している

```go
// Trace名
tracer := tp.Tracer(tracerName),

// Span名
spanCtx, span := tracer.NewSpan(ctx, "T001Usecase.Execute()")
```

### Jaegerでの検索

Jaegerだと、検索のプルダウンでは、以下のような項目がある

- `Service`:　サービス名
- `Operation`: Span名に該当する

### Datadogでの検索

DatadogのAPMのTracesでは、以下の項目で検索やフィルタリングができる (以下抜粋)。

- service: トレースが含まれるサービス名
- resource_name: トレースが関連するリソース（操作名）。これがSpan名に該当する
- operation_name: 明示的に指定できるかもしれないが、通常は設定しない

## まとめ

分散トレーシングにおいて、Span、Tag、Log/Event、およびBaggageはそれぞれ重要な役割を果たしている：

- **Span**: 操作やタスクの期間と詳細を表す基本単位。
- **Tag**: Spanにメタデータを追加するキー-バリューペア。
- **Log/Event**: Spanのライフサイクル中に発生した特定のイベントやログメッセージを記録。
- **Baggage**: 分散コンテキスト全体で共有されるデータを保持し伝播。

これらの機能を組み合わせて使用することで、分散システム内でのリクエストのフローを詳細に追跡し、効率的な監視とトラブルシューティングを行うことができるようになる。
