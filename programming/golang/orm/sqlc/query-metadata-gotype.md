# Sqlc クエリメタデータ `gotype`

`sqlc`のクエリメタデータで使用できる注釈の一つに`gotype`があり、この注釈を使うことで`クエリの結果を自分で定義したカスタム構造体にマッピングすることが可能`。これにより、クエリの結果をより柔軟に扱うことができる。

通常、sqlc は SQL クエリの結果を解析し、自動的に対応する Go の構造体を生成する。しかし、特定のデータモデルや特定の形式で結果を取得したい場合には、`gotype`を使ってカスタム構造体にクエリの結果をマッピングできる。

## `gotype`の使用例

### 1. カスタム構造体の定義

まず、SQL クエリの結果に対応するカスタム構造体を定義する。構造体のフィールド名と型は、クエリの結果セットに対応する必要がある。

```go
package db

type UserInfo struct {
    ID    int32  `json:"id"`
    Name  string `json:"name"`
    Email string `json:"email"`
}
```

### 2. SQL クエリファイルの記述

queries.sql に、`gotype`注釈を使ってカスタム構造体名を指定する。

**queries.sql**

```sql
-- name: GetUserInfo :one
-- gotype: UserInfo
SELECT id, name, email
FROM users
WHERE id = $1;
```

### 3. sqlc.yaml の設定ファイル

`sqlc.yaml`では通常通り、スキーマファイルとクエリファイルを指定する

**sqlc.yaml**

```yaml
version: "2"
sql:
  - engine: "postgresql"
    schema: "schema.sql"
    queries: "queries.sql"
    gen:
      go:
        package: "db"
        out: "db"
```

### 4. コード生成

通常通り、sqlc を実行して Go コードを生成

```sh
sqlc generate
```

### 生成された Go コードの例

**db/queries.sql.go**

```go
// Code generated by sqlc. DO NOT EDIT.
// source: queries.sql

package db

import (
    "context"
    "database/sql"
)

type UserInfo struct {
    ID    int32  `json:"id"`
    Name  string `json:"name"`
    Email string `json:"email"`
}

func (q *Queries) GetUserInfo(ctx context.Context, id int32) (UserInfo, error) {
    row := q.db.QueryRowContext(ctx, getUserInfo, id)
    var i UserInfo
    err := row.Scan(&i.ID, &i.Name, &i.Email)
    return i, err
}
```

### カスタム構造体の使用

生成された関数を使ってクエリを実行し、結果をカスタム構造体にマッピングする

**main.go**

```go
package main

import (
    "context"
    "database/sql"
    "log"

    _ "github.com/lib/pq"
    "example.com/myapp/db"
)

func main() {
    connStr := "user=username dbname=mydb sslmode=disable"
    dbConn, err := sql.Open("postgres", connStr)
    if err != nil {
        log.Fatal(err)
    }
    defer dbConn.Close()

    q := db.New(dbConn)
    ctx := context.TODO()

    userInfo, err := q.GetUserInfo(ctx, 1)
    if err != nil {
        log.Fatal(err)
    }

    log.Printf("User Info: %+v\n", userInfo)
}
```

## `gotype`の注意点

1. **構造体のフィールドとクエリ結果の一致**:

   - 構造体のフィールド名は、SQL クエリで取得するカラム名と一致する必要がある
   - フィールドの型も適切にマッピングされる必要がある

2. **構造体のスコープ**:

   - カスタム構造体は、`sqlc.yaml`で指定した出力パッケージ内に定義する。そうでない場合、適切にパッケージインポートを設定する必要がある。

3. **エクスポートされた構造体の再利用**:
   - 他のクエリでも同じ構造体を再利用したい場合、全てのクエリで同じ`gotype`注釈を使うことができる。
