# Standard Library

[Standard Library](https://pkg.go.dev/std)

## `v2`を持つ Standard Library

- **math/rand/v2**：
  このパッケージは、Go 1.22 で導入されたもので、既存の`math/rand`パッケージの問題点を解消するために作成された。これには、より良い乱数生成アルゴリズムや、ジェネリックなランダム・ナンバー生成関数が含まれる。
- **encoding/json/v2**:
  提案段階

## v2 パッケージの導入に関する一般的な方針

- **v2 パッケージの導入**：v2 パッケージは、既存のパッケージの問題点を解消するために作成される。既存のパッケージは非推奨にはならず、互換性を維持するために残る。
- **v2 パッケージの構成**：v2 パッケージは、v2 というサフィックスを含む異なるディレクトリに作成される。これにより、同時に開発と保守が行える。

## Go 1.22 で導入された`math/rand/v2`の仕様

Go 1.22 で追加された新しい乱数生成パッケージ`math/rand/v2`は、従来の`math/rand`を改良し、性能やセキュリティ面での向上を図っている。

### 主な変更点

- **非推奨メソッドの削除**:

  - `Rand.Read`および`Read`関数が削除された。暗号的乱数生成には`crypto/rand.Read`を使用することが推奨される。
    - [math/randとcrypto/randの使い分けについて](https://qiita.com/_ken_/items/736135c49b37080292fd)
  - `Source.Seed`および`Rand.Seed`メソッドが削除され、乱数生成器の初期化方法が変更された。

- **インターフェースの変更**:
  - `Source64`インターフェースが削除され、代わりに`Source.Uint64()`メソッドが統一的に利用されるようになった。
- **関数名のリネーム**:
  - `Intn, Int31, Int31n, Int63, Int64n`などは、それぞれ`IntN, Int32, Int32N, Int64, Int64N`にリネームされた。

### **新機能**

- **新しい乱数生成器**:

  - **PCG-DXSM**: 高速かつ統計的にランダム性が保証された擬似乱数生成器を導入。
  - **ChaCha8**: 暗号学的に強固な乱数生成器であり、従来の乱数生成器よりもセキュリティ面で優れている。グローバル乱数生成器として採用されている。

- **追加された関数**:

  - 符号なし整数の乱数生成用関数として、`Uint32, Uint32N, Uint64, Uint64N, Uint, UintN`が追加された。また、任意の整数型の乱数を生成する汎用関数`N`も導入されている。

- **アルゴリズムの改善**:
  - 新しいアルゴリズムとして Daniel Lemire 氏による高速な整数型乱数生成アルゴリズムを採用.

### **性能改善**

- 浮動小数点数乱数生成(`Float32`, `Float64`)では、以前必要だったリトライ処理が不要になり、効率化されている.
- `Rand.Perm`メソッドの内部実装において、処理速度向上のために`Rand.Shuffle`を利用する変更が加えられた.

### **セキュリティと利便性**

- `math/rand/v2`では暗号学的なランダム性を強化し、従来より安全な乱数生成を実現している。また、グローバルな乱数生成器として `ChaCha8` が採用されており、セキュリティ上の懸念が軽減されている.

これらの変更によって、従来よりも高速かつ安全な乱数生成が可能となり、開発者がより簡単に適切な用途に応じた乱数を利用できるようになった。

- [Slide: Go1.22からの疑似乱数生成器について](https://speakerdeck.com/convto/go-122-pseudo-random-generator)

### `math/rand/v2`による乱数生成

```go
rand.IntN(100) // e.g. 58

pcg := rand.NewPCG(42, 1024)
r2 := rand.New(pcg)
r2.IntN(100) // e.g 68
```
