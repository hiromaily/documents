# パフォーマンスチューニング

## 方法

1. **プロファイリング**:

   - `pprof`ツールを使用して CPU やメモリの使用状況を可視化し、ボトルネックを特定する。`net/http/pprof`パッケージを使った Web アプリケーションのプロファイリングも可能。

2. **GC の最適化**:

   - Golang のガベージコレクション(GC)のパフォーマンスを理解し、チューニングパラメータを調整します。具体的な方法として、`GOGC`環境変数を設定して GC の頻度を調整することがある。

3. **並行処理の適切な利用**:

   - Goroutine やチャンネルを効率的に使うことで、並行処理のパフォーマンスを向上させる。例えば、大量の軽量スレッド(Goroutine)を利用することで、I/O 待機時間を減少させることが可能。

4. **データ構造の選択**:

   - 適切なデータ構造を選択することで、メモリ使用量や処理時間を削減できる。特に大量の書き込みと読み取り操作がある場合、標準ライブラリのマップやシンクマップではなく、特化したデータ構造を用いることを検討する。

5. **バッチ処理の利用**:

   - データの一括処理を行うことで、ネットワークのラウンドトリップや I/O 操作のオーバーヘッドを減らすことができる。

6. **システムコールの最小化**:

   - 低レベルのシステムコールを減らすことで、再割り込みのオーバーヘッドを減少させることができる。例えばファイル I/O をまとめて行う、非同期 I/O を使うなど。

7. **効率的な I/O 操作**:

   - バッファリングを用いた I/O 操作を行うことで、パフォーマンスを向上させる。例えば、`bufio`パッケージを用いて、標準入力出力を効率的に処理する。

8. **同期の削減**:

   - LockやMutexの使用を最小限に抑えることで、スレッドの競合を減らしパフォーマンスを向上させる。

9. **コンパイラ最適化フラグの使用**:

   - プログラムをビルドする際に、`-gcflags`や`-asmflags`といったコンパイルオプションを調整することで、パフォーマンスの向上が図れる。

10. **キャッシュの活用**:
    - データの再計算や再取得を避けるために、キャッシュメカニズムを利用する。例えば、Go の標準ライブラリの`sync.Map`やサードパーティ製のキャッシュライブラリを活用する。

### goのビルド時のオプション

[内部Docs: go build](./go-command.md#ビルド時)

## PGO（Profile-Guided Optimization）

PGO（Profile-Guided Optimization）を有効化し、ほとんどのプログラムのパフォーマンスを 2%～ 14%向上させることができる（らしい）。

1. **プロファイルをインポートして有効にする**:

   - まず、`net/http/pprof`パッケージをインポートすることで、プロファイルを取得するためのエンドポイントが追加される。

2. **プロファイルを収集する**:

   - アプリケーションを通常通りビルドし、代表的な環境で実行する。標準的な負荷をかけながら、プロファイルをサーバーからダウンロードする。

     ```bash
     curl -o profile.pprof http://localhost:8080/debug/pprof/profile?seconds=60
     ```

3. **プロファイルを使って次のビルドを最適化する**:

   - 取得したプロファイルを使用して次のビルドを最適化する。Go ツールチェーンは、`main`パッケージディレクトリに`default.pgo`という名前のプロファイルがあれば自動的に PGO を有効にする。または、`-pgo`フラグを使って PGO に使用するプロファイルについて定義できる。

     ```bash
     go build -pgo profile.pprof -o app_pgo main.go
     ```

4. **改善を測定する**:
   - 最初のプロファイルを作成した環境を再現できる場合、最適化されたビルドで新しいプロファイルを収集する。`go tool pprof`コマンドを使って最初のプロファイルと比較し、CPU 使用率の減少を測定する。
