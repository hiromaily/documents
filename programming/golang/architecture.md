# [WIP] Architecture 考察と草案

アーキテクチャは記述すべき箇所を示す方針であるが、どのような構造が望ましいか考察する

## golang-standards/project-layout

- [https://github.com/golang-standards/project-layout](https://github.com/golang-standards/project-layout)
- 基本方針は、多くの人に認知されているこのパターンで問題ないと思う。
- 問題は、`pkg`配下をどのようにプロジェクトに合わせて構造化していくか。

## ドメイン駆動設計

- 開発手法のベースはこちらに習うほうが良い
- 厳密なドメイン駆動設計は不要だが、ドメインを明確にし、定義する構造体や機能があいまいにならないパッケージ毎の責務をはっきりさせる必要がある。凝縮度が重要。
- ドメイン名がそのままパッケージ名になる。

### 取り入れる部分と省く部分

- ドメインこそ明確に定義するが、厳密に値オブジェクト、エンティティ、ドメインサービスと分離を強制しない
- ドメインサービスを用意する場合、そのサービスはインターフェース化し、さらに実装においても内部は抽象化されたドメインのインターフェースを呼び出していくのみ
- データストア(ストレージ)はリポジトリに定義し、リポジトリは、`repository`というパッケージを用意し、その中をデータストアのミドルウェア（mysql, redis）などの階層を用意し、その中にテーブルごとにサブパッケージもしくはファイルを作成していく
  - こちらに記述するのは実装
  - そのインターフェースは適切なドメイン内に定義(respository 内ではない)
- アプリケーションサービスレイヤーは、`application`というパッケージを用意し、その中をドメインごとにサブパッケージを作成していく
  - この中に具体的なロジックは書かない。メインオブジェクトのタスク調整のみで、抽象化されたドメインのインターフェースを呼び出していく
- 明確なドメイン分離さえ守れれば、ファクトリーの使用は強制しない。
- 依存関係逆転の原則（Dependency Inversion Principle）に従う（上位レベルのモジュールは下位レベルのモジュールに依存してはならない、どちらのモジュールも抽象に依存すべき）
- DI Container、Dependency Injection パターンに従い、コンストラクタで依存するオブジェクトを注入する

### 取り入れるべきアーキテクチャー

- 以下はドメイン駆動設計と同時に語られることの多いアーキテクチャ

  - レイヤードアーキテクチャ
  - ヘキサゴナルアーキテクチャ
  - クリーンアーキテクチャ

- この中で新しく広く認識されている、クリーンアーキテクチャが良いか？大きな差異はないが、ヘキサゴナルアーキテクチャで問題なさそう。
- DDD 本に書かれているパターンではレイヤードアーキテクチャーが多く、こちらは古いので使わない。
- 以下は典型的な bad practice。概念を package 名にするのはわかりにくいし、golang らしさがないので鵜呑みにすべきではない。

```txt
[bad practice]

[DDD]---[Domain]
            |-[Models]---[domainA]
            |          |-[domainB]
            |-[Services]---serviceA
        [Application]
            |-[domainA]
            |-[domainB]
        [Infrastructure]
            |-[RDB]-----[TableA]
            |         |-[TableB]
            |-[Redis]---[TableA]
                      |-[TableB]
```

### pkg 配下の構造例

- 基本`pkg`配下はドメインレイヤーであり、その同階層に、`application`や`repository`を配置する
- ただし、可能であれば、そのドメインも大カテゴリごとに大まかに分類できたほうがいい
