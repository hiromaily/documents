# proto for Typescript (Node.js)

[buf](https://buf.build/docs/introduction)を使うほうが楽で、[ts-proto](https://github.com/stephenh/ts-proto)をプラグインとして利用できる

## Using Node.js for gRPC

- [grpc-tools](https://www.npmjs.com/package/grpc-tools)
  - This package distributes the Protocol Buffers compiler protoc along with the plugin for generating client and service objects for use with the Node gRPC libraries.
  - This library exports the grpc_tools_node_protoc executable, which accepts all of the same arguments as protoc itself.
- [grpc_tools_node_protoc_ts](https://www.npmjs.com/package/grpc_tools_node_protoc_ts)
  - Generate corresponding TypeScript d.ts codes according to js codes generated by grpc_tools_node_protoc.
- [@grpc/grpc-js](https://www.npmjs.com/package/@grpc/grpc-js)
  - Pure JavaScript gRPC Client
- [google-protobuf](https://www.npmjs.com/package/google-protobuf)
  - Protocol Buffers - Google's data interchange format
- [@types/google-protobuf](https://www.npmjs.com/package/@types/google-protobuf)
  - This package contains type definitions for google-protobuf

```sh
yarn add --dev grpc-tools grpc_tools_node_protoc_ts
yarn add @grpc/grpc-js google-protobuf @types/google-protobuf
```

```sh
# use protoc on bash
PROTOC="`yarn bin`"/grpc_tools_node_protoc
```

### Option

- [protoc-gen-ts](https://www.npmjs.com/package/protoc-gen-ts)
  - typescript plugin
- [ts-proto](https://www.npmjs.com/package/ts-proto)
  - it transforms your .proto files into strongly-typed, idiomatic TypeScript files.

```sh
--ts_proto_opt="esModuleInterop=true,forceLong=long,useOptionals=true,outputTypeRegistry=true"
```

## Proto files の build 方法

```sh
PLUGIN_TS=./node_modules/.bin/protoc-gen-ts
PLUGIN_GRPC=./node_modules/.bin/grpc_tools_node_protoc_plugin
DIST_DIR=./src

protoc \
--js_out=import_style=commonjs,binary:"${DIST_DIR}"/ \
--ts_out=import_style=commonjs,binary:"${DIST_DIR}"/ \
--grpc_out="${DIST_DIR}"/ \
--plugin=protoc-gen-grpc="${PLUGIN_GRPC}" \
--plugin=protoc-gen-ts="${PLUGIN_TS}" \
--proto_path=./proto/proto/rippleapi \
--proto_path=./proto/proto/third_party \
./proto/proto/rippleapi/*.proto
```

```sh
PROTOC="`yarn bin`"/grpc_tools_node_protoc
PROTO_DIR="./proto"
THIRD_PARTY_PROTO_DIR="./third_party/proto"
OUT_DIR="./src/tmp/"

proto_dirs=$(find $COSMOS_PROTO_DIR -path -prune -o -name '*.proto' -print0 | xargs -0 -n1 dirname | sort | uniq)
for dir in $proto_dirs; do
  $PROTOC \
  --plugin="$(yarn bin protoc-gen-ts_proto)" \
  --ts_proto_out="$OUT_DIR" \
  --proto_path="$PROTO_DIR" \
  --proto_path="$THIRD_PARTY_PROTO_DIR" \
  --ts_proto_opt="esModuleInterop=true,forceLong=long,useOptionals=true,outputTypeRegistry=true" \
  $(find "${dir}" -maxdepth 1 -name '*.proto')
done
```
