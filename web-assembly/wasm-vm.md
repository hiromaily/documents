# WASM 仮装マシン / VM

例えば Rust で書いたコードを WASM としてコンパイルすると、生成されたバイナリがブラウザ上で`WebAssembly仮想マシン`によって実行される。

WebAssembly（略称: Wasm）仮想マシン（VM）は、WebAssembly バイナリ形式のコードを実行するための仮想環境。これは、特定のプラットフォームやアーキテクチャに依存せず、効率的で高性能なコード実行を目指す設計となっている。

## WebAssembly 仮想マシンの特徴

1. **プラットフォーム独立**: WebAssembly バイナリはハードウェアやオペレーティングシステムに依存せず、どのプラットフォーム上でも同じように動作することを目標としている。

2. **高パフォーマンス**: WebAssembly は低レベルの命令セットを持ち、高速なバイトコードで記述されている。これにより、ほぼネイティブのパフォーマンスに近い速度でコードが実行される。

3. **セキュリティ**: WebAssembly はサンドボックス化されており、悪意のあるコードからシステムを保護する。メモリやリソースアクセスも制限されているため、セキュアな実行環境を提供する。

4. **モジュール性**: WebAssembly はモジュール単位で動作し、それぞれのモジュールが独立して動作する。また、複数のモジュール間での関数やメモリの共有も可能。

## WebAssembly 仮想マシンの仕組み

1. **バイトコード形式**: 高級言語（例えば Rust や C/C++）で書かれたコードは、`WebAssembly 用のバイトコード`にコンパイルされる。このバイトコードは`.wasm`ファイルとして保存される。

2. **実行環境**: WebAssembly 仮想マシンはこのバイナリ形式のコードを実行するための環境を提供する。ブラウザや他のホスト環境には、WebAssembly Runtime が含まれており、これが仮想マシンの役割を果たす。

3. **インスタンス化**:

   - **ロード**: `.wasm`ファイルをメモリにロードする。ブラウザでは`fetch` API や XHR などを使ってサーバからファイルを取得する。
   - **インスタンス生成**: ロードされたバイナリデータを WebAssembly モジュールとしてインスタンス化する。この際、JavaScript API を使用する。例えば、`WebAssembly.instantiate`関数が使われる。

4. **エクスポートとインポート**:

   - **エクスポート**: WebAssembly モジュールは関数やメモリ空間をエクスポートして外部からアクセス可能にする。JavaScript コードからこれらのエクスポートされた関数を呼び出すことができる。
   - **インポート**: 逆に、WebAssembly モジュールはホスト環境（例えば JavaScript）の関数やオブジェクトをインポートして使用することも可能。

5. **実行**: インスタンス化された WebAssembly モジュールは、その中の関数を JavaScript から呼び出すことで実行される。この過程で、仮想マシンがバイトコードを解釈またはネイティブコードにコンパイルし、直接実行する。

## まとめ

WebAssembly 仮想マシンは、クロスプラットフォームでネイティブ性能に近いコードの実行を可能にするための仮想環境。バイトコード形式でコードを配布し、ブラウザや他のホスト環境の組み込み WebAssembly VM によってこれを実行する。これにより、安全で効率的なアプリケーションの実行が可能になる。
