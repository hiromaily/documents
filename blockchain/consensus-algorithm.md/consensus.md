# Consensus Mechanism

- コンセンサスアルゴリズムとも言われ、分散ネットワーク上の(相互に信用をしていない)複数のノードが単一の結果について合意を形成するに当たって生じる問題を解決するためのアルゴリズム
- その結果、全ノードがデータベースの同一のコピーを維持することになる

## References

- [コンセンサスアルゴリズムとは？](https://academy.binance.com/ja/articles/what-is-a-blockchain-consensus-algorithm)
- [Ethereum Proof-Of-Stake](https://ethereum.org/en/developers/docs/consensus-mechanisms/pos/)

## 大まかな挙動

- まず、ブロックを追加したいユーザー(バリデーター)に`ステーク`を提供することを要求する。
- ステークとは、バリデータが不正な行動をしないようにするために、バリデータが提示しなければならないある種の価値のことで、バリデータが不正を行えば、そのステークを失うことになりる。Stake の例としては、計算能力、暗号通貨、あるいは評判など。
- ユーザーが自分自身のリソースをリスクにさらすのは、`報酬`を得ることができるからであり、この報酬はたいていの場合、プロトコルのネイティブ暗号通貨で構成されており、他のユーザーによって支払われた手数料、発行されたばかりの暗号通貨、またはその両方で構成されている。
- 最後に必要なのは、`透明性`。誰かが不正をしたら検知できる必要がある。ブロックを発行するにはコストがかかるものの、その検証は安価にできることが理想的である。これによって、バリデーターは一般のユーザーによって、監視され続けるようになる。

## コンセンサスアルゴリズムの種類

1. Proof of Work (PoW)
2. Proof of Stake (PoS)
3. Proof of Authority (PoA)

他にも様々なアルゴリズムが存在する

## Proof of Work（PoW）

- バリデーター(マイナーと呼ばれる)は特定の解を見つけ出すまで、追加したいデータをハッシュし続ける。
  - ハッシュは、一見ではただのランダムな文字と数字の文字列で、ハッシュ関数を通してデータを実行したときに作成される。しかし、同じデータでハッシュ関数を再度実行すると、いつも同じ出力になるようになっている。しかし、元のデータを少しでも変更すると、出力されるハッシュは全く違ったものになる。
  - 出力された結果を見るだけでは、ハッシュ関数を実行する前の情報が何だったのかを予想することはできません。だから、ある時間より前にそのデータについて知っていたことを証明するのに便利。誰かにそのハッシュを与えて、後でデータを公開したときに、その人は関数を通してそれを実行して、出力が同じであることを確認することができる。
- プルーフオブワークでは、プロトコルが有効なブロックの条件を設定している。例えば、`00` でハッシュが始まるブロックのみが有効みたいな条件が設定されているかもしれない。マイナーがその組み合わせに合うものを作る唯一の方法はブルートフォースでの総当たりしかない。彼らは、正しいハッシュを得るまで、推測ごとに異なる結果を生み出すために、データのパラメータを微調整することができる。
- 主要なブロックチェーンでは、この条件は信じられないほど高く設定されている。他のマイナーと競争して、有効なブロックを発行する機会を得るには、特別なハッシュ用のハードウェア(ASIC)でいっぱいの倉庫が必要となる。
- マイニングを行う時のステークは、これらのマシンのコストとそれらを動かすために必要となる電気代が該当する。ASIC は 1 つの目的のためだけに作られているので、暗号資産マイニング以外のアプリケーションには使うことができない。初期投資を回収する唯一の方法はマイニングである。ブロックチェーンへの新しいブロックの追加に成功したら、大きな報酬を得ることができる。
- ネットワークが、あなたが本当に正しいブロックを作成したかどうかを確認するのは簡単なこと。あなたが正しいハッシュを得るために何兆もの組み合わせを試したとしても、ネットワークはあなたのデータを一度だけハッシュ関数を通して実行すれば十分。あなたのデータが有効なハッシュを生成した場合、それは受け入れられ、あなたは報酬を得ることができる。そうでなければ、ネットワークはそれを拒否し、そのために費やした時間と電気が無駄となる。
- PoW が大きな価値のあるネットワークで展開されたら、そのシステムはゲーム理論と金銭的インセンティブの分野になります

### 詳細

[Proof of Work（PoW）とは？](https://academy.binance.com/ja/articles/proof-of-work-explained)

- ダブルスペンド(同じ資金が同時に 2 人の受取人に使用されてしまう問題)を防ぐための仕組みのこと
- 取引がまとめてブロックに追加されるが、作成されたブロックは一旦`Candidtte Block`に追加される。候補ブロックが確定ブロックになった時、初めて有効化される
- ブロックを追加する権利を得るために、マイナー(ブロックを作成するユーザー)は、ブロックデータをハッシュ化(ハッシュ関数を使用してブロックハッシュを生成すること)し、回答を得る必要がある
- 入力データを得るためにブロックハッシュから逆算することは事実上不可能
- ハッシュ関数を使用して入力データを送信し、出力データと一致するかを確認する
- この回答となる入力データを得るために、データを少し変更し、上述の処理を再度実行する必要がある
- 通常、追加を希望する Transaction 情報をすべて取得後、その他の重要な`Nonce`と言われる変数データを追加し、すべてハッシュ化する。この行為がマイニングと呼ばれる。
- 要約すると、マイニングとはブロックチェーンのデータを集め、特定のハッシュを見つけるまでナンスと一緒にハッシュ化するプロセス
- プロトコルで定められた条件を満たすハッシュが見つかった場合、新しいブロックをネットワークにブロードキャストする権利を得ることができる
- ネットワーク上の[ハッシュレート](https://academy.binance.com/en/glossary/hash-rate)が高ければ高いほど、有効なハッシュを見つけることが難しくなる

- 悪意のあるユーザーが大量の不正な取引をブロックに入れ、有効なハッシュの生成を妨害するような不正行為が発生した場合、これをどう防ぐか？
  - 取引が作成される場合、ユーザーは署名をする。
  - ネットワーク上のすべてのユーザーが署名を公開鍵と比較することができ、署名と公開鍵が一致するかどうかを確認することができる。
  - また、ユーザーが実際に資金を使用する権利の有無や、入力データの合計が出力データの合計よりも高いかどうか（つまり、あなたが持っている以上のものを使用していないかどうか）を確認する。
- 無効な取引を含むブロックは、ネットワークによって自動的に拒否される。あなたが不正行為を行う場合、多くのコストが発生し、報酬を受け取ることもできず、自身のリソースを無駄にしてしまう。

## Proof of Stake (PoS)

- 一般的に Staking をするには、一定の資産を保有することが必要となる。
- そうしたら、ウォレットに資産をロックする(ステーキング中はこの資産を移動することはできない)。
- 一般的には、他のバリデーターとともに、次のブロックにどのトランザクションが入るかを合意することになる。
- ある意味では、選択されるブロックに賭けていることになり、プロトコルがその中から 1 つを選ぶ。
- あなたのブロックが選択されたら、トランザクション手数料の一部を受け取る。より多くの資産をロックアップすると、より多くを手に入れることができる。しかし、無効なトランザクションを提案することで不正をしようとしたら、ステークしている資産の一部、もしくは全ての失うことなる。そのため、PoW と同様に誠実に行動することは不誠実に行動するよりも多くの利益を得られるというメカニズムが採用されている。
- 一般的に、バリデーターへの報酬の一部として、新しく作られたコインが配布されることはない。したがって、ブロックチェーンのネイティブ通貨は、何らかの別の方法で発行されなければならない。これは、最初の配布（すなわち、ICO または IEO）、または後に PoS に移行する前に PoW でプロトコルをローンチさせることによって行うことができる。

- PoS システムをハッキングするためのノウハウを持っている人は、そのハッキングによってより多くの利益を得られる場合のみ攻撃をする。そのため、PoS が安全に機能するかは実際にネットワーク上で稼働させてみないとわからない。

### 詳細

[Proof of Stake (PoS) とは?](https://academy.binance.com/ja/articles/proof-of-stake-explained)

- バリデーター(参加者)はコインをステークする必要があり、コインをステークしたことを証明するだけ
- Proof of Stake アルゴリズムは、疑似ランダム選択プロセスを使用して、ノードのグループからバリデーターを選択する。
- システムは、ステーキング期間、ランダム化の要素、ノードの資産などの要因の組み合わせを使用する。
- Proof of Stake のシステムでは、ブロックはマイニングされるのではなく「生成」される
- 大半の Proof of Stake の仮想通貨は、ノードをすぐに稼働できるように「生成済み」の供給コインを使用する
- 生成プロセスに参加するユーザー(バリデーター)は、一定量のコインをステークして、ネットワークにロックする必要がある。
- ステークのサイズによって、ノードが次のバリデーターとして選択される可能性が決まる。
- つまり、ステークしている枚数が多いほど、チャンスは大きくなる。
- ただし、Proof of Stake を採用している各ブロックチェーンでは、`独自のメソッドが選択プロセスに追加されている`ため、ネットワーク内の最も裕福なノードが必ずしも、優先されるわけではない。
- 最も一般的に使用される 2 つの方法は、ランダム化ブロック選択(Randomized Block Selection)とコインエイジの選択(Coin Age Selection)。

#### ランダム化ブロック選択 (Randomized Block Selection)

- バリデーターは、最小ハッシュ値と最大ステークの組み合わせを持つノードを探すことによって選択される。
- ステークのサイズは公開されているため、次の生成者は通常、他のノードによって予測することができる。

#### コインエイジの選択 (Coin Age Selection)

- トークンがステークされた期間に基づいてノードを選択する。
- コインエイジは、コインがステークされた日数にステークされたコインの数を掛けることによって計算される。
- ノードがブロックを生成すると、そのコインエイジはゼロにリセットされ、別のブロックを生成できるようになるまで一定期間待たなければならない。
- これによって、大きなステークノードがブロックチェーンを支配するのを防ぐ。

#### トランザクションの検証

- Proof of Stake アルゴリズムを使用する各仮想通貨には、ネットワークとそのユーザーにとって、可能な限り最良の組み合わせを実現するために組み合わせられた、独自のルールとメソッドのセットが存在する。
- ノードが次のブロックを生成するように選択した場合、ブロック内のトランザクションが有効かどうかがチェックされる。
- 次にブロックに署名をして、ブロックチェーンに追加する。
- 報酬として、ノードはブロックからトランザクション手数料を受け取り、一部のブロックチェーンではコイン報酬を受け取ることができる。
- ノードがバリデーターをやめたい場合、そのステークと獲得した報酬は一定期間後にリリースされ、ノードによってブロックチェーンに不正なブロックが追加されていないことを確認する時間がネットワークに与えられる。

### Pros and Cons

- Pros
  - 必要となるエネルギー消費量が少ない
  - PoS の汎用性が高いため、様々なユースケースに対応可能
  - 適応性が高いことで、より多くのユーザーがノードを実行できるようになり、結果、分散性とスケーラビリティが高くなる
  -
- Cons
  - 通貨を保有していない場合、ネットワークに参加することが難しい
  - 時価総額の低いブロックチェーンでは、51%攻撃が簡単に実現できてしまう

### PoS を使用している Blockchain

- Ethereum 2.0
- Tendermint
- BNB Smart Chain
- Solana
- Avalanche
- Polkadot

#### PoS ベースの他のコンセンサスメカニズム

- Delegated Proof of Stake (DPoS)
  - ユーザーはバリデーターにならずにコインをステークすることができる。
  - この場合、デリゲーターはブロック報酬を共有するために支持するバリデーターに対してステーキングする。
  - より多くのデリゲーターからの支持を集めたバリデーターは、ブロックの検証に選ばれる可能性が高くなる。
  - バリデーターは通常、デリゲーターと共有される金額をインセンティブとして変更できる。
  - バリデーターの評判もデリゲーターにとって重要な要素となる。
- Nominated Proof of Stake (NPoS)
  - Polkadot が開発したコンセンサスモデル
  - Delegated Proof of Stake と多くの類似点がある
  - ノミネーター (デリゲーター) が悪意のあるバリデーターを支持してステークした場合、ステークしているコインを失う可能性がある
- Proof of Staked Authority (PoSA)
  - BNB Smart Chain で採用されている
  - Proof of Authority と Proof of Stake を組み合わせて、バリデーターが交代でブロックを生成する
  - 21 人のアクティブなバリデーターのグループが参加する資格があり、彼らがステークした BNB の枚数、もしくはどれだけデリゲーターからの支持を得たかによって選択される
  - このセットは毎日決定される

## Proof of Authority (PoA)

[Proof of Authority Explained](https://academy.binance.com/ja/articles/proof-of-authority-explained)

- 1 秒当たりのトランザクション数(TPS)がしばしば問題になるが、PoS ネットワークは PoW より優れているものの、この問題を解決しなかった
- これに対して、PoA はより効率的な代替え手段として実装されており、高い TPS を実現できる
- PoA は特に PrivateNetwork で実用的で効率的に機能する reputation ベースのコンセンサスアルゴリズムとなる
- これはアイデンティティ価値を活用する、つまりバリデーターは Coin をステーキングするのではなく、自分の評判をステーキングすることになる
- PoA ブロックチェーンは、信頼できるエンティティとして任意に選択された検証ノードによって保護される
- PoA モデルは、限られた数のブロックバリデーターに依存しており、ブロックとトランザクションは事前承認済みの参加者によって検証される
- PoA モデルにより、企業はブロックチェーン技術の利点を活用しながらプライバシーを維持できる
- PoA は Coin の代わりに ID を活用する修正された PoS であると考えることもできる

### PoA コンセンサスの条件

- PoA コンセンサスアルゴリズムは通常、以下に依存している
  - 有効で信頼できる ID: バリデーターは実際の ID を確認する必要がある
  - バリデーターになることの難しさ: 疑わしいバリデーターを選択するリスクを軽減する
  - バリデーター承認の基準: バリデーターを選択する方法は、すべての候補者と同等である必要がある
- Requtation メガニズムの背後にある本質は、バリデーターの身元の背後にある確実性だが、これは簡単なプロセスではない
- 悪いプレイヤーを排除する必要がある
