# [The Graph](https://thegraph.com/)

- ブロックチェーンデータをインデックス化して照会するための分散型プロトコル
- ブロックチェーンデータをインデックス化し、誰もがクエリできるサブグラフと呼ばれるオープン API で公開
- Ethereum や InterPlanetary File System (IPFS)のようなストレージネットワーク上に簡単に dApp を構築できるようにすることを目的としている
- 開発者は[Graph Explorer](https://thegraph.com/explorer)を使用して、分散型アプリケーションを構築するために必要な全ての公開データ（サブグラフ）を検索することができる
- 誰でも DeFi や Web3 エコシステムの主要プロジェクトからのデータによるサブグラフを構築し、公開することが可能

## [The Graph - GRT カリキュラム](https://pol.techtec.world/ja/blockchain-usecase/thegraph)

### The Graph が生まれた背景

ブロックチェーン上の情報収集の難しさが課題としてある。まず、条件を持つ複雑なクエリへの対応が難しい。ブロックチェーンは大きなデータを保存したり、たくさんの処理を行うことには向いていない。実際に NFT に紐づけられる画像などの多くは、IPFS をはじめとする分散型ストレージなどの外部システムに保存されている。その解決策としてインデックスを作成することがあるが、インデックス作成を行うために、DApps の開発者が独自のインデックス用サーバを用意する場合、サーバには管理者が必要となってしまう。

### The Graph の特徴

The Graph はインデックスの作成とクエリ処理を行うための分散型のプロトコル。イーサリアムなどのブロックチェーンや分散型ファイルシステム`IPFS`などに保存されたデータのインデックスを作成することにより、DApps からのクエリを効率的に処理することを可能にする。このような特徴から The Graph は「ブロックチェーン界の Google」とも呼ばれている。The Graph は Uniswap など、すでに多くのアプリケーションに利用されている。

### The Graph で Index を作成する「サブグラフ」

The Graph を利用する際、インデックス作成用の独自サーバは不要。インデックスの作成を行うためには、`サブグラフ`と呼ばれるオープン API を構築し公開する。`サブグラフ`は、インデックスを作成したいデータとどのように保存するかを定義するものであり、誰でも作成することができる。The Graph へのクエリは`GraphQL`を利用して行われる。

### The Graph を構成する要素

- Developer：The Graph を利用した DApps の開発者。インデックス作成を行いたいデータについて Subgraph を作成する
- Indexer：インデックスの作成を行いクエリを処理する
- Curator：インデックスの作成をするサブグラフを指し示す
- Delegator：Indexer に GRT トークンをステークする（預ける）ことでネットワークのセキュリティを強化する

### GRT トークン

The Graph ネットワークでは`GRTトークン`というネイティブトークンが利用されている。GRT トークンの目的は、ネットワークのセキュリティ強化とガバナンス、および The Graph ネットワークの貢献者への経済的な動機付けによるネットワークの繁栄。

Indexer、 Curator、 Delegator はそれぞれの仕事を適切に行うことで GRT トークンを獲得できるというインセンティブが用意されている。GRT トークンをうまく活用することで参加者がネットワークにとって良い行動をとってくれるようコントロールしている。このような、仕事を行うことで報酬としてトークンを獲得できる仕組みは `Work トークンモデル`と呼ばれている。  
一方で、仕事を行うためには GRT トークンの`Staking`が必要。不正への対策として、Staking された GRT トークンを没収する `Slashing`` と呼ばれる仕組みも存在する。

GRT トークンの代表的な用途としては、`クエリ fee`がある。The Graph にクエリを投げる DApps の開発者などのコンシューマーは、クエリ処理を行う Indexer にクエリ料として GRT トークンを支払う。

GRT トークンはイーサリアムの ERC-20 に準拠している。初期総供給量は 100 億 GRT でしたが、インデックス作成の報酬として年間 3％が新規発行されている。一方で、クエリ料の 1％以下や Deposit 税、Slashing で没収されたトークンが Burn（焼却）される仕組みも用意されている。したがって、供給量は `100 億 GRT + 新規発行量 - バーン量`で計算される。

### Developer とサブグラフ

開発者がどのようなデータをどのように保存するのかを定義するために作成するのがサブグラフ。開発者がサブグラフを公開するまでの流れを以下にまとめる。

1. 開発者はサブグラフの作成
2. デプロイ
3. テスト
4. The Graph の分散型ネットワークに公開

注意点として、一度公開を行ったサブグラフは削除することはできない

#### サブグラフの構成

- マニフェスト：インデックスを作成するデータソースなどを定義
- GraphQL スキーマ：サブグラフが保存するデータと形式を定義
- マッピングス：データソースから受け取ったデータをスキーマの形式に変換するプログラム

#### デプロイ先

1. サブグラフスタジオ: Ethereum Mainnet 上のデータのインデックスを作成する際に利用さる
2. Hosted Service: ベータ版として Ethereum Mainnet 以外のネットワークにも対応しているが、分散性はない。(廃止予定)

#### Graph Explorer

公開したサブグラフは Graph Explorer から見ることが可能

## References

- [The Graph について知っておくべき重要事項（GRT）](https://medium.com/the-graph-protocol-japan/the-graph%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E7%9F%A5%E3%81%A3%E3%81%A6%E3%81%8A%E3%81%8F%E3%81%B9%E3%81%8D%E9%87%8D%E8%A6%81%E4%BA%8B%E9%A0%85-grt-ec5761b7c83d)
