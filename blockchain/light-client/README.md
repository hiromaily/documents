# Light Client

- [IBC Light Client](https://ibcprotocol.org/lightClients/)
- [Blockchain Light Client](https://medium.com/codechain/blockchain-light-client-1171dfa1269a)


## 概要
- Light Clientはトランザクションの状態を検証するが、そのためにブロックチェーンの一部の情報のみを保存する
- ブロックチェーンの構造は、Header, Transaction, State, Cacheとなっている
- Header
  - Chainを形成する最小単位の構造で、以下が含まれる
    - 前のブロックのHash
    - タイムスタンプ
  - Light Clientの目的はヘッダーを検証すること
  - ヘッダーを検証するだけで Merkle ツリー内のすべての情報が検証される
- Header+Transaction
  - これが「ブロック」になる
  - ブロックを提案/マイニングするノードはブロックを公開し、他のノードはそれらのブロックを検証する
- Header+Transaction+State
  - ヘッダーによって検証できる最大の範囲
  - すべてのノードがまったく同じ値を持つことがプロトコルで保証されている単位

### ヘッダー検証
- ヘッダーはMerkle Rootがある限り、トランザクションと状態を検証できる

#### PoWの場合
1. 以前のHash, タイムスタンプ, フォーマットの基本情報を確認
2. HeaderのNonceを確認してPoWを完成させる
- TransactionやStateの確認の不要

#### PoSの場合
1. 以前のHash, タイムスタンプ, フォーマットの基本情報を確認
2. バリデータセットの情報を確認
3. Voteを確認する
4. それらのVoteがシェアの2/3を超えているかどうかを確認する
- PoSでは、状態の一部である、「バリデーターセット」が必要となる

### アルゴリズム
- Light ClientがTransactionまたは状態を検証するためには、周囲のフルノードに`merkle proof`を要求し、検証済みヘッダーの`merkle root`を使用して検査する
- よって、ヘッダーも検証する必要があるのだが、ヘッダーは`前のブロックのHash`を含んでいるおり、これは前のブロックのヘッダーを検証することによってのみ知ることができる
- さらに、`バリデータ セット情報` は前のブロックの状態を検証することによってのみ知ることができる
- 対象のヘッダーを検証するために必要な前のブロックに関する情報を検証するには同じ方法を使用して再帰的に検証する必要がある

### PoW のLight Client
- ヘッダーに`merkle root`が含まれていれば可能となる

1. ブロックヘッダーの取得
  - ノードは、検証したいトランザクションを含むブロックのヘッダー`H`を取得。
  - 周囲の他のノードに取得を依頼するか、ローカル コンピューターにあるまだ検証されていないノードを選択することができる。

2. `H` が既に検証されているかどうかの確認
  - `H` が既に検証されている場合は、`Step 6` に進む。
  - 検証済みの `H` を `H'` とすると、これは`H` が 以下の場合に発生する可能性がある
    - Genesis ブロックのヘッダー
    - ノードが以前に検証したヘッダー
    - または信頼できるノードによって提供されたヘッダー

3. `H` の前のヘッダー`H_p`を受け取る。
  - ここからが、ヘッダーの検証手順

4. `H_p` は、これらすべてのプロセスの再帰によって検証され、これを `H_p'` と呼ぶ
  - 前述のように、Light Clientの検証プロセスは帰納的(誘導的) [inductive]
  - 対象のヘッダーを最終的に検証するには、前のヘッダーを検証する必要がある。
  - これは、手順 1 ～ 6 の再帰によって解決可能
  - (基本ケースは `Step 2` を参照)

5. `H_p'` を使用して `H` を検証する
  - 前のヘッダーでヘッダーを検証する方法は、上記のとおり
  - 1. 前のハッシュを含むヘッダーの基本情報を検証し、 
  - 2. PoWの結果であるナンスを検証する。
  - この場合、「前のハッシュ」を把握するために `H_p` が必要となる

6. ノードが最初に確認したいトランザクション/状態を含むブロックのヘッダーが 検証済み`H'`かどうかの確認
  - 既にヘッダーが確認済みの場合は `Step 7` に進む。
    - これは、再帰プロセスを完了した後、スタックの一番上にいることを意味する 
  - そうでない場合は、再帰を `Step 4` に戻す。

7. ノードが検証したいトランザクション/状態 `T` を検証する
  - これは、`T` が実際にブロックで使用されているかどうかを確認することを意味する
  - `T` が存在するブロックの証明されたヘッダー `H'` が既に存在する
  - `T` を検証するために必要な`Merkle proof` (Merkle rootへのパス上に存在する他のノード) をフルノードに要求する

8. 現在表示しているチェーンが最長のブロックチェーンであるかどうかを確認
  - PoW は、最も長い (計算量が最も多い) チェーンに同意する
  - Light Client が見ているのは、正確にはブロックチェーンではなく、一連のヘッダー
  - しかし、チェーンヘッダーの長さを確認するだけで、実際に合意された最長のブロックチェーンのヘッダーであることを確認できる

9. `T` とその`Merkle proof`を計算して、`H'` で記述された`Merkle root`と同じかどうかを確認する


### PoS のLight Client

### Optimization


## Tendermint
- [Light Client](https://docs.tendermint.com/v0.34/tendermint-core/light-client.html)
- [Go Package](https://pkg.go.dev/github.com/tendermint/tendermint/light)
