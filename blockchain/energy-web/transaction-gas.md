# Transaction and Gas Cost

## References
- [Transactions and Transaction Costs](https://energy-web-foundation.gitbook.io/energy-web/foundational-concepts/transaction-costs)

## トランザクション
- トランザクションとは、ブロックチェーンの状態を変更または更新するあらゆる「書き込み」操作のこと
- トランザクションは常に externally owned account(外部所有のアカウント)によって 開始され、完了するためにはトランザクションを開始したアカウント所有者によって署名される必要がある
- 書き込みトランザクションの例としては、以下のようなものがある
  - アカウント間のトークンの移動
  - 新しいスマートコントラクトやアカウントのデプロイ
  - 既存のスマートコントラクトを呼び出したり、相互作用させる

- Initiator(開始者)によって確認されると、トランザクションは保留と検証の2つの状態になることができる

### 未決済のトランザクション
- Proof-of-Authorityコンセンサス Blockchainでは、バリデータが 順番にトランザクションを検証し、ブロックを封鎖する
- トランザクションは検証される前に、メモリプール（mempool）で `保留` の状態にある

### 有効なトランザクション
- トランザクションはバリデータによって検証された後、ブロックに追加される
- ブロックチェーンの各ブロックは、 厳密な順序で連続した、検証済みのトランザクションから 構成されている
- 有効なトランザクションのTransaction Feeは`EWT`の値を持っている

## Transaction Costの決定
- チェーンを更新するすべてのトランザクションにはトランザクションコストがかかる
- `読み取り専用`のトランザクション、つまりブロックチェーンの状態を更新しないトランザクションにはコストがかからない
- あるトランザクションは他のトランザクションより計算量が多く、あるトランザクションは緊急性が高く、あるトランザクションはより高度なプライバシーを必要とするなど、すべてのトランザクションが同じように作られているわけではない
- 例えば、複雑な機能を持ち、保存する内部変数が多いスマートコントラクトとのやり取りは、あるアカウントから別のアカウントへの単純なトークンの移動よりも計算量が多くなる
- 後述するように、こうしたトランザクションごとの違いは、最終的なトランザクションコストに影響を与える可能性がある

### Transaction Cost 変数
重要な変数は以下の３つ

#### 1.Gas Cost:
- トランザクションの計算の複雑さは、トランザクションを完了するために実行される各オペレーションコード（命令）に数値を割り当てる単位である`Gas`で測定される
- トランザクションのガスコストは、実行する必要があるコードの量と高度さ、そして結果としてブロックチェーンに保存されるデータの量と種類によって決定される
- トランザクションが複雑であればあるほど、Gas Costは高くなる


#### 2.Gas Price:
- 具体的な料金を導き出すには、ガス料金も必要
- トランザクションを開始するすべてのユーザーは、その特定のトランザクションに対して、その時点で支払ってもよいと思うGas Priceを選択する
- これは本質的に、ユーザーが自分のトランザクションを検証し、チェーンに追加するために行う入札のようなもの
- 例えば、自分のトランザクションを迅速に行いたいユーザーは、次の利用可能なブロックにできるだけ早く含まれるように、より高いGas Priceを入札するかもしれない
- Gas Priceは、EWチェーンでは`EWT`（通常は 10億分の1のEWTを表すgweiなどの極小単位）で表示される
- Gas Priceは、ガス1単位あたりのトークン（gwei）で表される

#### 3.Token Value
- Token Value（通常はfiat currencyに相当する額で表される）は、仮想的なトランザクションコストを「現実の」トランザクションコストに変換する
- そして、トークン市場の変動によりトークン価値が大きく変動すると、トランザクションコストも変動する


## Transaction Costの計算
- 上記の3つの変数を使用すると、総トランザクションコストを計算することができる
```
TxCost(unit:fiat$) = GasCost(unit:gas) x gasprice(unit:token/gas) x tokenvalue($/token)
```
- EWCでのトランザクションを想定した場合の手数料の算出方法は以下のとおり
```
50,000ガス×1ガスあたり1gwei＝50,000gwei＝0.00005EWT
```
- トランザクション時の EWT の市場価格が 1 ドルであった場合、手数料は 0.00005 ドルに相当する
- EWTの価格が10ドルだった場合、これは0.0005ドルに相当する


## Gas Price, Gas Limit, Blockサイズ
- ブロックの時間を一定に保ち、任意のブロックがトランザクションで過負荷になるのを防ぐため、EWチェーンでは 各ブロックで消費できる ガスの量にあらかじめ上限が 設定されている
- EWCの各ブロックには、`800万ユニットのガスのサイズ制限`がある
-  Gas Costは、バリデータがトランザクションの検証やブロックのsealingを 行う際の計算負荷を表している
-  ガス料金はEWTで表示され、バリデータにその作業に対する対価が支払われる
-  各バリデータは、自分のブロックにトランザクションを含めるために、受け入れ可能なガス価格の下限を独自に設定することができる
-  現在EWCでは、デフォルトは `0.1gwei` だが、全体の範囲は`0.01gweiから1gwei`の間
-  EWチェーンでトランザクションを開始する場合、ガス価格が少なくとも`0.01gwei`であることを確認し、 次の1～3ブロック（およそ15秒）以内にトランザクションが実行されるようにしたい場合は、より高いガス価格を選択する必要がある
- 各トランザクションで使用するガスの量が異なるため、1ブロックに収まるトランザクション数は変動する
- EWCの各ブロックには、800万ユニットのガスというサイズ制限がある
- 仮に、極めて計算量の多い1つのトランザクションで800万個のガスを消費しても、2つのアカウント間の単純なEWTの送金（最も基本的なトランザクションタイプ）では`21,000`のガスが消費される可能性がある
- メモリプールで待機しているトランザクションの多くが低い計算コストであれば、より多くのトランザクションをブロックに収めることができる
- それらが大きければ、ブロックが保持するトランザクションは少なくなる


## Transactionコストを抑えるために
1. `無駄のないスマートコントラクトは、ガス代の抑制に役立つ`
    - アプリ開発者やスマートコントラクトの作成者は、無駄のない効率的なコード、つまりできるだけ計算効率の高いスマートコントラクトを書き、トランザクションを開始するインセンティブを得ることができる
2. `Gas Priceの入札は、トランザクション容量の大きいネットワークでは低く抑えられるはず`
    - トランザクションコストに影響を与える3つの変数のうち、Gas Priceは間違いなく最も強力な手段
    - なぜなら入札された価格は、ネットワークにトランザクションを送信するユーザーの裁量にのみ依存するから
    - 後述する理由により、ブロックの「混雑」が続かない場合、ガス価格は低く安定的に推移する可能性がある
3. `ジャスト・イン・タイム のGas Price計算により、トークン価値のボラティリティのリスクをある程度軽減できる`
    - さまざまな理由により、トークン市場の中には他の市場よりも変動が激しいものがある
    - しかし、トークンのfiat currencyに対する価値が変化したからといって、トランザクション手数料が警告なしに同様に変化するわけではない
    - ユーザーはトランザクション時にGas Priceの入札を調整するため、その時のトークンの価値に相対する額面のトークンを入札する
    - 過去のトランザクション手数料が現在（または将来）のトークン価値に対して大幅に高くなったり安くなったりする可能性はあるが、発生時のトランザクション手数料はfiat currencyの関数として比較的安定した状態を保つはず

## ユーザーが低コストのネットワークを望むのであれば、そもそもなぜトランザクションコストが上昇するのだろうか?
- では、なぜ誰もがどんなトランザクションでも高い値段で入札するのだろうか
- 合理的な利用者は常にコストを最小限に抑えようとするため、トランザクション手数料は非常に低いままであるべきではないだろうか
- 現実には、トランザクション手数料は、トランザクションを確認するためのユーザー間の競争によって正確に変化する
- ある瞬間には、何百、何千ものトランザクションが確認され、正式にブロックチェーンに追加されるのを待っているかもしれない
- これらの保留中のトランザクションはメモリプール（mempool）に置かれ、最終的にバリデータ（PoW型ブロックチェーンの場合はマイナー）によってブロックに含まれるかどうかが選択される
- しかし、各ブロックには有限のGas Limitがあり、すべてのトランザクションを一度に確認することはできない
- その結果、バリデータは通常、メモリプールの中で最も有利な（見方によっては高価な）トランザクションを優先することになる
- 手数料の安いトランザクションは、結局確認されるのを待たねばならないかもしれない
- 結局のところ、手数料はトランザクションの 優先順位付けのためのものとなる
- Gas Priceが高ければ高いほど、トランザクションの確認が早くなる
- トランザクションの確認にかかる時間を気にしないのであれば、非常に低い（または全くない）Gas Priceを提供することができる
- しかし、この方法では、トランザクションが確認されることなく、いつまでもメモリプール キューに残ってしまう危険性がある

## エネルギー・ウェブ・チェーンに関する知見からの教訓
- 最も基本的なレベルでは、EWCのトランザクション手数料は、供給（例：ブロックガスの上限とブロック速度/時間によって定義されるネットワークの計算能力）と需要（例：保留中のトランザクション数）の関数として決定される
- 供給（ブロックタイムとブロック Gas Limit）は基本的に固定されているのに対し、需要はユーザー数、メモリプール内のトランザクションの量と複雑さの関数として変動するため、ボラティリティが方程式に含まれるようになる
- トランザクション手数料のトレンドがトランザクション量と乖離することもあるが、一般にこの2つは相関関係にある
- 2019年6月のEWC開始以降の過去のデータを見ると、トランザクション手数料は通常極めて低いと言える
- 平均ブロック利用率（ガス消費量）は15～20％程度で、2ブロック以内にトランザクションが検証されるためには、最低0.1gweiというGas Priceだけでほぼ十分となる
- EWTの過去の市場価格に基づいて、fiat currencyで表されるトランザクション手数料は、通常0.0001ドルの範囲（またはそれ以下）
